<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PROJECT REVS</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        :root {
            --primary-magenta: #C231E0;
            --secondary-purple: #6B58E7;
            --primary-dark: #1B0025;
            --secondary-dark-blue: #2B0B58;
            --accent-blue: #6EA2E0;
            --accent-neon-blue: #00c3ff;
            --text-light: #e5e7eb;
            --text-dark: #a1a1aa;
            --success: #00ff85;
            --danger: #ff4141;
            --warning: #f7ff00;
            
            --rarity-common: #a1a1aa;
            --rarity-rare: var(--accent-blue);
            --rarity-epic: var(--secondary-purple);
            --rarity-legendary: var(--warning);

            --faction-arcane: var(--secondary-purple); 
            --faction-wild: var(--accent-blue);
            --faction-shadow: #a1a1aa;

            --type-passive: var(--accent-blue);
            --type-hybrid: var(--secondary-purple);
            --type-active: var(--primary-magenta);
        }

        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            font-family: 'Poppins', sans-serif; 
            background: var(--primary-dark); 
            color: var(--text-light); 
            overflow-x: hidden; /* Prevents unwanted horizontal scrollbars */
            -webkit-tap-highlight-color: transparent; 
        }
        
        #sound-control { position: fixed; top: 20px; left: 20px; z-index: 9999; cursor: pointer; width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; transition: background 0.2s; }
        #sound-control:hover { background: rgba(0,0,0,0.8); }

        /* === GLOBAL ANIMATIONS === */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes glow-primary { 0%, 100% { box-shadow: 0 0 8px var(--primary-magenta), 0 0 12px var(--primary-magenta); } 50% { box-shadow: 0 0 25px var(--primary-magenta), 0 0 40px var(--primary-magenta); } }
        @keyframes card-reveal { 0% { transform: scale(0.8) rotateY(180deg) translateZ(50px); opacity: 0; } 50% { transform: scale(1.1) rotateY(0) translateZ(100px); opacity: 1; box-shadow: 0 0 60px var(--primary-magenta); } 100% { transform: scale(1) rotateY(0) translateZ(0); box-shadow: 0 0 25px var(--primary-magenta); } }
        @keyframes portal-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes animated-bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes mission-claim { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(194, 49, 224, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(194, 49, 224, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(194, 49, 224, 0); } }
        @keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 50px; } }
        @keyframes flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { text-shadow: 0 0 5px var(--primary-magenta), 0 0 10px var(--primary-magenta), 0 0 20px var(--primary-magenta), 0 0 40px var(--secondary-purple), 0 0 70px var(--secondary-purple); color: var(--text-light); } 20%, 24%, 55% { text-shadow: none; color: #111; } }
        
        /* Glitch effect for screen transitions */
        @keyframes screen-glitch-out { 0% { transform: translate(0); clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 20% { transform: translate(-5px, 3px); clip-path: polygon(0 10%, 100% 10%, 100% 70%, 0 70%); } 40% { transform: translate(5px, -3px); clip-path: polygon(0 40%, 100% 40%, 100% 50%, 0 50%); } 60% { transform: translate(-3px, 1px); clip-path: polygon(0 80%, 100% 80%, 100% 95%, 0 95%); } 80% { transform: translate(1px, -1px); clip-path: polygon(0 25%, 100% 25%, 100% 35%, 0 35%); } 100% { transform: translate(0); clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } }
        
        /* Screen shake effect */
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-3px, 3px); } 20%, 40%, 60%, 80% { transform: translate(3px, -3px); } }
        .shake-effect { animation: screen-shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }


        /* === REBEL IMMERSION ANIMATIONS (NEW) === */
        @keyframes subtle-breathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes pulse-glow-ability {
            0%, 100% { box-shadow: 0 0 15px 0px var(--accent-neon-blue), inset 0 0 8px var(--accent-neon-blue); }
            50% { box-shadow: 0 0 30px 8px var(--accent-neon-blue), inset 0 0 12px var(--accent-neon-blue); }
        }
        @keyframes selection-glitch {
            0% { filter: none; }
            25% { filter: brightness(1.5) contrast(1.5); transform: translate(2px, -2px); }
            50% { filter: none; transform: translate(-2px, 2px); }
            75% { filter: brightness(0.8) contrast(1.2); }
            100% { filter: none; }
        }
        @keyframes trick-win-glow-anim {
            0%, 100% { box-shadow: 0 0 10px var(--success); }
            50% { box-shadow: 0 0 30px var(--success); }
        }
        @keyframes trick-lose-glow-anim {
            0%, 100% { box-shadow: 0 0 10px var(--danger); }
            50% { box-shadow: 0 0 30px var(--danger); }
        }

        /* ✨ NEW: Animação de Evolução do Herói */
        @keyframes hero-evolve-glow {
            0% { transform: scale(1); box-shadow: 0 0 15px var(--warning); filter: brightness(1.2); }
            50% { transform: scale(1.1); box-shadow: 0 0 60px 20px var(--warning), inset 0 0 20px var(--warning); filter: brightness(2); }
            100% { transform: scale(1); box-shadow: 0 12px 25px rgba(0,0,0,0.6); filter: none; }
        }
        .evolving {
            animation: hero-evolve-glow 0.8s ease-out forwards;
        }

        /* === STRUCTURE AND SCREENS === */
        .screen { position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1rem; box-sizing: border-box; background-color: var(--primary-dark); overflow-y: auto; transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out; }
        .screen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px); background-size: 1px 2px; animation: scanlines 1s linear infinite; pointer-events: none; z-index: 0; transition: all 0.5s; }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.98); filter: blur(8px); }
        #splash-screen {
            background-image: linear-gradient(rgba(27, 0, 37, 0.7), rgba(27, 0, 37, 0.9)), url('https://i.imgur.com/8UD5Mtr.png');
            background-size: cover;
            background-position: center;
            z-index: 100;
        }
        #hero-management-screen, #gacha-screen, #hero-selection-screen, #truco-screen, #tutorial-screen { 
            background: linear-gradient(170deg, var(--secondary-dark-blue) 0%, var(--primary-dark) 100%);
            background-size: 200% 200%; 
            animation: animated-bg 30s ease infinite; 
            justify-content: flex-start; 
            padding-top: 2rem; 
        }
        #main-lobby {
            background-image: linear-gradient(rgba(27, 0, 37, 0.8), rgba(43, 11, 88, 0.9)), url('https://i.imgur.com/NxIVeIQ.png');
            background-size: cover;
            background-position: center;
            justify-content: flex-start;
            padding-top: 2rem;
            position: relative; /* Necessário para o z-index do pseudo-elemento funcionar */
        }
        .splash-title { font-family: 'Orbitron', sans-serif; font-size: 3.5rem; position: relative; animation: flicker 3s linear infinite; }
        .splash-logo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 1.5rem;
            border: 3px solid var(--primary-magenta);
            box-shadow: 0 0 25px var(--primary-magenta), inset 0 0 10px var(--primary-magenta);
            animation: float 4s ease-in-out infinite;
            background-color: var(--primary-dark);
        }

        /* === ADIÇÃO: Fundo dinâmico para o Lobby === */
        @keyframes move-twinkle-back {
            from {background-position:0 0;}
            to {background-position:-10000px 5000px;}
        }

        #main-lobby::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1; /* Fica atrás de todo o conteúdo */
            background: transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center;
            animation: move-twinkle-back 200s linear infinite;
        }
        
        /* === LOBBY AND MISSIONS (OLD) === */
        .player-stats { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; background: rgba(27, 0, 37, 0.7); padding: 0.5rem 1rem; border: 1px solid rgba(194, 49, 224, 0.3); margin-bottom: 1.5rem; position: relative; backdrop-filter: blur(5px); clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px)); }
        .currency-display { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; font-family: 'Rajdhani', sans-serif; }
        .coin-display { color: var(--text-light); }
        .gem-display { color: var(--primary-magenta); }
        .level-badge { background: linear-gradient(to right, var(--secondary-purple), var(--primary-magenta)); padding: 0.35rem 1rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600; color: var(--primary-dark); }
        .xp-bar-container { width: 80px; height: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        .xp-bar-fill { height: 100%; background: linear-gradient(to right, var(--primary-magenta), var(--secondary-purple)); border-radius: 5px; }
        .game-card { background: linear-gradient(145deg, var(--secondary-dark-blue), #0f0f24); border-radius: 1.5rem; padding: 2rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; border: 1px solid rgba(194, 49, 224, 0.2); transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .game-card::before, .game-card::after { content: ''; position: absolute; width: 20px; height: 20px; transition: all 0.3s; }
        .game-card::before { top: 10px; left: 10px; border-top: 2px solid transparent; border-left: 2px solid transparent; }
        .game-card::after { bottom: 10px; right: 10px; border-bottom: 2px solid transparent; border-right: 2px solid transparent; }
        .game-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-magenta); box-shadow: 0 0 30px rgba(194, 49, 224, 0.4); }
        .game-card:hover::before { border-color: var(--primary-magenta); }
        .game-card:hover::after { border-color: var(--primary-magenta); }
        .game-icon { font-size: 3rem; color: var(--primary-magenta); }
        .game-title { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--primary-magenta); }
        #missions-container { position: fixed; bottom: 90px; right: 20px; background: rgba(27, 0, 37, 0.8); backdrop-filter: blur(8px); border: 1px solid var(--primary-magenta); border-radius: 1rem; padding: 1rem; width: 300px; max-width: 90vw; z-index: 1002; transform: translateX(calc(100% + 40px)); transition: transform 0.4s ease-in-out; pointer-events: none; }
        #missions-container.show { transform: translateX(0); pointer-events: auto; }
        .mission-progress-fill { height: 100%; background: var(--primary-magenta); }

        /* === GACHA / RECRUITMENT === */
        .gacha-card { background: var(--secondary-dark-blue); border-radius: 20px; padding: 1.5rem; border: 4px solid var(--primary-magenta); }
        .gacha-hero-name { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--primary-magenta); }
        .gacha-placeholder { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: rgba(194, 49, 224, 0.5); }
        
        /* GACHA CARD SHUFFLE ANIMATION (NEW) */
        #gacha-card-shuffler {
            width: 250px;
            height: 350px;
            display: none;
            position: relative;
            margin: 1.5rem 0;
            perspective: 1000px;
        }
        #gacha-card-shuffler.active {
            display: block;
        }
        .shuffle-card {
            position: absolute;
            width: 100px;
            height: 140px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(160deg, var(--accent-blue) 0%, var(--accent-neon-blue) 100%);
            border-radius: 8px;
            border: 2px solid var(--accent-neon-blue);
            box-shadow: 0 0 15px var(--accent-neon-blue);
            opacity: 0;
            animation: shuffle-animation 2.5s ease-in-out forwards;
        }
        .shuffle-card::before {
            content: "R";
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-dark);
            text-shadow: 0 0 10px var(--primary-dark);
            font-size: 40px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes shuffle-animation {
            0% { transform: translate(calc(var(--i) * 40px - 80px), -300px) rotate(calc(var(--i) * 5deg + 45deg)); opacity: 0; }
            25% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
            75% { transform: translate(-50%, -50%) rotate(calc(var(--i) * 15deg - 30deg)) translateX(calc(var(--i) * 20px - 40px)); opacity: 1; }
            100% { transform: translate(calc(var(--i) * -40px + 80px), 300px) rotate(calc(var(--i) * -5deg - 45deg)); opacity: 0; }
        }


        /* === HOLOGRAPHIC BUTTONS === */
        @keyframes glow-primary-btn {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 8px var(--primary-magenta);
                box-shadow: inset 0 0 15px rgba(194, 49, 224, 0.4), 0 0 15px rgba(194, 49, 224, 0.4);
            }
            50% {
                transform: scale(1.02);
                text-shadow: 0 0 12px #fff, 0 0 20px var(--primary-magenta), 0 0 30px var(--secondary-purple);
                box-shadow: inset 0 0 25px rgba(194, 49, 224, 0.8), 0 0 40px rgba(194, 49, 224, 0.8);
            }
        }

        @keyframes glow-special-btn {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 8px var(--accent-neon-blue);
                box-shadow: inset 0 0 15px rgba(0, 195, 255, 0.4), 0 0 15px rgba(0, 195, 255, 0.4);
            }
            50% {
                transform: scale(1.02);
                text-shadow: 0 0 12px #fff, 0 0 20px var(--accent-neon-blue), 0 0 30px var(--accent-blue);
                box-shadow: inset 0 0 25px rgba(0, 195, 255, 0.8), 0 0 40px rgba(0, 195, 255, 0.8);
            }
        }

        @keyframes glow-danger-btn {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 8px var(--danger);
                box-shadow: inset 0 0 15px rgba(255, 65, 65, 0.4), 0 0 15px rgba(255, 65, 65, 0.4);
            }
            50% {
                transform: scale(1.02);
                text-shadow: 0 0 12px #fff, 0 0 20px var(--danger), 0 0 30px var(--danger);
                box-shadow: inset 0 0 25px rgba(255, 65, 65, 0.8), 0 0 40px rgba(255, 65, 65, 0.8);
            }
        }

        @keyframes glow-success-btn {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 8px var(--success);
                box-shadow: inset 0 0 15px rgba(0, 255, 133, 0.4), 0 0 15px rgba(0, 255, 133, 0.4);
            }
            50% {
                transform: scale(1.02);
                text-shadow: 0 0 12px #fff, 0 0 20px var(--success), 0 0 30px var(--success);
                box-shadow: inset 0 0 25px rgba(0, 255, 133, 0.8), 0 0 40px rgba(0, 255, 133, 0.8);
            }
        }

        .btn-primary, .btn-special, .btn-danger, .btn-success {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            margin: 5px;
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Rajdhani', sans-serif;
            border: 1px solid;
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            clip-path: polygon(0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
        }

        .btn-primary:hover:not(:disabled), .btn-special:hover:not(:disabled), .btn-danger:hover:not(:disabled), .btn-success:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
            filter: brightness(1.3);
        }

        .btn-primary:active:not(:disabled), .btn-special:active:not(:disabled), .btn-danger:active:not(:disabled), .btn-success:active:not(:disabled) {
            transform: translateY(0px) scale(0.98);
            filter: brightness(1.5);
            transition: transform 0.1s;
        }

        /* Color Variations */
        .btn-primary {
            border-color: var(--primary-magenta);
            color: var(--primary-magenta);
            animation: glow-primary-btn 2.5s infinite ease-in-out;
        }
        .btn-primary:hover:not(:disabled) {
            box-shadow: inset 0 0 25px rgba(194, 49, 224, 0.7), 0 0 35px rgba(194, 49, 224, 0.7);
        }

        .btn-special {
            border-color: var(--accent-neon-blue);
            color: var(--accent-neon-blue);
            animation: glow-special-btn 2.5s infinite ease-in-out;
        }
        .btn-special:hover:not(:disabled) {
            box-shadow: inset 0 0 25px rgba(0, 195, 255, 0.7), 0 0 35px rgba(0, 195, 255, 0.7);
        }

        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
            animation: glow-danger-btn 2.5s infinite ease-in-out;
        }
        .btn-danger:hover:not(:disabled) {
            box-shadow: inset 0 0 25px rgba(255, 65, 65, 0.7), 0 0 35px rgba(255, 65, 65, 0.7);
        }

        .btn-success {
            border-color: var(--success);
            color: var(--success);
            animation: glow-success-btn 2.5s infinite ease-in-out;
        }
        .btn-success:hover:not(:disabled) {
            box-shadow: inset 0 0 25px rgba(0, 255, 133, 0.7), 0 0 35px rgba(0, 255, 133, 0.7);
        }

        .btn-primary:disabled, .btn-special:disabled, .btn-danger:disabled, .btn-success:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: rgba(100, 100, 100, 0.1); 
            box-shadow: none; 
            border-color: #555;
            color: #777;
            text-shadow: none;
            animation: none;
        }

        #briefing-tabs .btn-special {
            background: #2B0B58;
            border-color: #4a2c7a;
            box-shadow: none;
            opacity: 0.7;
        }
        #briefing-tabs .btn-special.active {
            background: linear-gradient(45deg, var(--secondary-purple), #8758e7);
            border-color: var(--secondary-purple);
            box-shadow: 0 4px 15px rgba(107, 88, 231, 0.2);
            opacity: 1;
        }

        /* === HEROES / REBELS === */
        .hero-card { 
            background: linear-gradient(145deg, var(--secondary-dark-blue), #0f0f24); 
            border: 2px solid rgba(194, 49, 224, 0.2); 
            transition: all 0.3s; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); 
            border-radius: 1rem; 
            padding: 1rem; 
            cursor: pointer; 
            position: relative;
            width: 100%;
            max-width: 250px;
        }
        .hero-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.6); }
        .hero-card.selected { border-color: var(--warning); box-shadow: 0 0 25px var(--warning), inset 0 0 10px var(--warning); clip-path: polygon(0 15px, 15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px)); }
        .hero-card img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-magenta); margin-bottom: 1rem; object-fit: cover; margin-left: auto; margin-right: auto; animation: subtle-breathing 5s ease-in-out infinite; }
        .hero-name { font-family: 'Orbitron', sans-serif; font-size: 1.25rem; color: var(--primary-magenta); }
        .hero-duplicates-bar { width: 100%; height: 12px; background: rgba(0,0,0,0.5); border-radius: 6px; margin-top: 0.5rem; overflow: hidden; }
        .hero-duplicates-fill { height: 100%; background: linear-gradient(to right, var(--rarity-rare), var(--rarity-epic)); transition: width 0.5s; border-radius: 6px; }
        .faction-badge { position: absolute; top: 10px; left: 10px; padding: 2px 8px; font-size: 0.7rem; border-radius: 99px; color: white; font-weight: bold; }
        .faction-Arcane { background-color: var(--faction-arcane); } .faction-Wild { background-color: var(--faction-wild); } .faction-Shadow { background-color: var(--faction-shadow); }
        .hero-tooltip { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: var(--primary-dark); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--primary-magenta); width: 200px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10; font-size: 0.8rem; }
        .hero-card:hover .hero-tooltip { opacity: 1; }
        .hero-team-slot { width: 80px; height: 80px; background: radial-gradient(circle, rgba(194, 49, 224, 0.1) 0%, rgba(194, 49, 224, 0) 70%); border: 2px dashed #555; border-radius: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.5rem; color: #777; padding: 0.5rem; transition: all 0.3s; }
        .hero-team-slot:not(:empty) { border-style: solid; border-color: var(--primary-magenta); }
        .hero-team-slot img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem; }

        /* ✨ NEW: Hero Card border colors by rarity */
        .hero-card.rarity-common { border-color: var(--rarity-common); }
        .hero-card.rarity-rare { border-color: var(--rarity-rare); }
        .hero-card.rarity-epic { border-color: var(--rarity-epic); }
        .hero-card.rarity-legendary { border-color: var(--rarity-legendary); }

        /* === HERO SELECTION SCREEN REWORK === */
        #hero-selection-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 2rem;
        }
        .hero-selection-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border-radius: 1rem;
            border: 1px solid var(--secondary-purple);
        }
        .hero-selection-column h3 {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid;
            width: 100%;
            text-align: center;
        }
        .passive-column h3 { color: var(--type-passive); border-color: var(--type-passive); }
        .hybrid-column h3 { color: var(--type-hybrid); border-color: var(--type-hybrid); }
        .active-column h3 { color: var(--type-active); border-color: var(--type-active); }
        .hero-card.selected-animation-effect { animation: selection-glitch 0.4s ease-out; }

        /* === NOTIFICATIONS === */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            background: linear-gradient(45deg, var(--secondary-dark-blue), #0f0f24);
            border-left: 4px solid var(--primary-magenta);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            opacity: 0;
            transform: translate(-50%, -20px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        #notification.show {
            opacity: 1;
            transform: translate(-50%, 0);
            pointer-events: auto;
        }
        #notification i {
            font-size: 1.5rem;
            color: var(--primary-magenta);
        }
        
        /* === TRUCO / REVS --- NEW LAYOUT === */
        @keyframes tech-grid-pan { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
        
        /* CYBERNETIC CARD PLAY ANIMATION */
        @keyframes cyber-play {
            0% {
                transform: scale(1.8) rotateZ(-20deg) translateY(-100px);
                opacity: 0;
                filter: brightness(2.5);
                box-shadow: 0 0 50px var(--accent-neon-blue), 0 0 30px var(--primary-magenta);
            }
            60% {
                transform: scale(0.9) rotateZ(10deg);
                opacity: 1;
                filter: brightness(1.5);
            }
            100% {
                transform: scale(1) rotateZ(0deg);
                opacity: 1;
                filter: brightness(1);
                box-shadow: 0 0 10px rgba(0, 195, 255, 0.3);
            }
        }
        .card-played-animation {
            animation: cyber-play 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.5) forwards;
        }

        #truco-screen {
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-areas: "sidebar main";
            height: 100vh;
            width: 100%;
            padding: 1.5rem;
            gap: 1.5rem;
            box-sizing: border-box;
            justify-content: center;
            align-items: center;
        }
        
        /* *** NOVO: Estilos para o modo Mão de Ferro *** */
        #truco-screen.iron-hand-mode {
            grid-template-columns: 1fr !important;
            grid-template-areas: "main";
        }
        #truco-screen.iron-hand-mode #truco-sidebar {
            display: none;
        }
        
        .truco-main-area { 
            grid-area: main; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            position: relative;
            height: 100%;
        }
        #truco-sidebar { 
            grid-area: sidebar; 
            display: flex;
            flex-direction: column;
        }
        
        /* ✨ NOVO: Animação de Glitch para a mesa */
        @keyframes tech-glitch {
            0%, 100% { background-position: 0 0; opacity: 1; }
            20% { background-position: 5px -5px; opacity: 0.8; }
            40% { background-position: -5px 5px; opacity: 1; }
            60% { background-position: 5px 5px; opacity: 0.9; }
            80% { background-position: -5px -5px; opacity: 1; }
        }

        .truco-table {
            width: 100%;
            max-width: 900px;
            aspect-ratio: 16 / 10;
            background-color: var(--primary-dark);
            background-image: 
                linear-gradient(rgba(194, 49, 224, 0.1) 1px, transparent 1px), 
                linear-gradient(to right, rgba(194, 49, 224, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0;
            animation: tech-grid-pan 4s linear infinite, glow-primary 6s infinite alternate;
            border: 2px solid var(--primary-magenta);
            border-radius: 20px;
            box-shadow: 
                inset 0 0 15px rgba(194, 49, 224, 0.6),
                0 0 25px rgba(194, 49, 224, 0.6);
            padding: 2rem;
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            gap: 1rem;
            position: relative;
            align-items: center;
            transition: all 0.5s;
        }
        
        .player-area { display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; width: 100%; }
        .table-center { display: flex; justify-content: space-around; align-items: center; }
        
        .hand { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 120px; 
            perspective: 1000px;
        }
        .hand .card { margin: 0 -20px; }
        
        .hand .card:hover { z-index: 10; filter: brightness(1.2); box-shadow: 0 0 30px var(--accent-neon-blue); }
        .hand .card.selected-to-play { transform: translateY(-30px) scale(1.1); border-color: var(--primary-magenta); box-shadow: 0 0 25px var(--primary-magenta); }

        .table-slot { width: 90px; height: 130px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .vira-container { text-align: center; }
        #truco-actions { position: relative; display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem 0; }
        
        /* ===== INÍCIO DAS NOVAS ANIMAÇÕES ===== */
        
        /* ✨ NOVO: Animação do texto de "Revolução!" */
        @keyframes truco-text-anim {
            0% {
                transform: translate(-50%, -50%) scale(0.5) rotate(-15deg);
                opacity: 0;
                text-shadow: 0 0 5px #fff;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(5deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
                text-shadow: 0 0 10px var(--primary-magenta), 0 0 20px var(--secondary-purple), 0 0 40px #fff;
            }
        }
        
        /* UPDATED GLOW ANIMATION */
        @keyframes manilha-glow { 
            0%, 100% { box-shadow: 0 0 15px 2px var(--primary-magenta), 0 0 5px 1px var(--accent-neon-blue); } 
            50% { box-shadow: 0 0 30px 8px var(--primary-magenta), 0 0 15px 5px var(--accent-neon-blue); } 
        }

        /* NEW IMPACT ANIMATION */
        @keyframes table-slam-effect {
            0% {
                transform: scale(1) rotate(0);
                filter: none;
            }
            15% {
                transform: scale(1.05) translate(-10px, 5px) rotate(-1deg);
                filter: brightness(1.5) saturate(2);
            }
            30% {
                transform: translate(10px, -8px) rotate(1deg);
            }
            50% {
                transform: scale(1.01) rotate(0.5deg);
                filter: none;
            }
            100% {
                transform: scale(1) rotate(0);
            }
        }
        
        /* NEW BROKEN SCENARIO EFFECT */
        .scenario-broken .truco-table {
            filter: hue-rotate(5deg) contrast(1.1);
            animation: tech-grid-pan 2s linear infinite, glow-primary 4s infinite alternate;
        }

        .scenario-broken::before {
            animation: scanlines 0.5s linear infinite;
            opacity: 0.15; 
        }

        /* ===== FIM DAS NOVAS ANIMAÇÕES ===== */
        
        /* === HOLOGRAPHIC CARD ANIMATIONS (NEW) === */
        @keyframes card-materialize {
            0% {
                opacity: 0;
                transform: scale(0.8) rotateY(90deg) skew(15deg);
                filter: brightness(3) blur(5px);
            }
            50% {
                opacity: 0.7;
                filter: brightness(2) blur(2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateY(0deg) skew(0deg);
                filter: none;
            }
        }

        .card-materializing {
            animation: card-materialize 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0; /* Starts invisible */
        }

        @keyframes slot-impact-glitch {
            0%, 100% {
                border-color: rgba(255,255,255,0.2);
                box-shadow: none;
            }
            50% {
                border-color: var(--warning);
                box-shadow: 0 0 25px var(--warning);
                transform: translate(2px, -2px) skew(-3deg);
            }
        }

        .slot-impact {
            animation: slot-impact-glitch 0.2s ease-out;
        }

        /* === TRUCO / REVS --- CARD VISUAL IDENTITY UPDATE (START) === */

        #truco-screen .card {
            width: 85px;
            height: 120px;
            position: relative;
            flex: 0 0 auto;
            border-radius: 10px;
            font-weight: bold;
            overflow: hidden;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            box-sizing: border-box;
            background: linear-gradient(160deg, rgba(10, 31, 68, 0.75) 0%, rgba(43, 11, 88, 0.75) 100%);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(0, 195, 255, 0.5);
            box-shadow: inset 0 0 0 1px rgba(0, 195, 255, 0.2), 0 8px 15px rgba(0,0,0,0.5);
        }

        #truco-screen .card::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 15px;
            height: 15px;
            border-top: 2px solid;
            border-left: 2px solid;
            border-color: var(--accent-neon-blue);
            opacity: 0.7;
            transition: all 0.3s;
        }

        #truco-screen .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 50%;
            height: 100%;
            transform: skewX(-20deg);
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            transition: left 0.6s ease-in-out;
        }

        #truco-screen .card.playable:hover::after {
            left: 150%;
        }

        #truco-screen .card.playable:hover::before {
            transform: scale(1.1);
            opacity: 1;
        }

        #truco-screen .card.red { 
            color: #ff5555; 
            text-shadow: 0 0 8px #ff5555;
        }
        #truco-screen .card.black { 
            color: var(--accent-neon-blue); 
            text-shadow: 0 0 8px var(--accent-neon-blue);
        }

        #truco-screen .card .rank { 
            font-size: 2rem;
            font-family: 'Orbitron', sans-serif;
            align-self: flex-start;
        } 
        #truco-screen .card .suit {
            font-size: 1.8rem;
            align-self: flex-end;
        }

        #truco-screen .card.back { 
            background: linear-gradient(160deg, var(--accent-blue) 0%, var(--accent-neon-blue) 100%); 
        }
        #truco-screen .card.back::before { 
            content: "R"; 
            font-family: 'Orbitron', sans-serif; 
            color: var(--primary-dark); 
            text-shadow: 0 0 10px var(--primary-dark); 
            font-size: 40px; 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            border: none; /* Remove o canto da carta virada */
        }

        #truco-screen .card.playable:hover { 
            transform: translateY(-20px) scale(1.1);
            border-color: var(--accent-neon-blue);
            box-shadow: 0 0 25px var(--accent-neon-blue), inset 0 0 0 1px var(--accent-neon-blue);
        }

        #truco-screen .card.selected-to-play { 
            transform: translateY(-30px) scale(1.15); 
            border-color: var(--warning); 
            box-shadow: 0 0 30px var(--warning); 
        }

        #truco-screen .card.manilha-glow { 
            animation: manilha-glow 2s infinite; 
            border-color: var(--primary-magenta);
        }

        /* === TRUCO / REVS --- CARD VISUAL IDENTITY UPDATE (END) === */

        #truco-text-overlay { font-family: 'Orbitron', sans-serif; font-size: 6rem; color: var(--primary-magenta); text-shadow: 0 0 10px var(--primary-magenta), 0 0 20px var(--secondary-purple), 0 0 40px #fff; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; pointer-events: none; opacity: 0; }
        #truco-text-overlay.show { opacity: 1; }
        #truco-banter-box { border: 1px solid var(--secondary-purple); transition: opacity 0.5s; opacity: 0; padding: 0.5rem 1rem; background: rgba(0,0,0,0.5); border-radius: 0.5rem; margin-bottom: 1rem; }
        .vira-container .badge { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border: 1px solid var(--primary-magenta); padding: 4px 8px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        #status { font-size: 1.1rem; color: var(--warning); font-weight: bold; animation: flicker 4s linear infinite; }

        /* === SIDEBAR IMMERSION STYLES (NEW) === */
        #truco-sidebar .sidebar-hero-card {
            transition: all 0.3s ease-in-out;
        }
        #truco-sidebar .sidebar-hero-card.ability-ready-glow {
            animation: pulse-glow-ability 2s infinite ease-in-out;
            border-color: var(--accent-neon-blue);
        }
        #truco-sidebar .sidebar-hero-card.is-speaking {
            transform: scale(1.05);
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px var(--accent-blue);
        }
        #truco-sidebar .sidebar-hero-card.trick-win-glow {
            animation: trick-win-glow-anim 0.8s ease-out;
        }
        #truco-sidebar .sidebar-hero-card.trick-lose-glow {
            animation: trick-lose-glow-anim 0.8s ease-out;
        }

        /* === CARD BATTLE ANIMATIONS === */
        #battle-arena .card {
            position: absolute;
            transform-origin: center center;
            z-index: 100;
        }
        #battle-arena .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        /* Enter Arena */
        @keyframes battle-enter-left {
            from { transform: translate(-200px, 0) scale(0.8) rotate(-15deg); }
            to { transform: translate(-60px, 0) scale(1.2) rotate(-5deg); }
        }
        @keyframes battle-enter-right {
            from { transform: translate(200px, 0) scale(0.8) rotate(15deg); }
            to { transform: translate(60px, 0) scale(1.2) rotate(5deg); }
        }
        .battle-enter-player { animation: battle-enter-left 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .battle-enter-ai { animation: battle-enter-right 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        /* === NEW EPIC BATTLE ANIMATION: DIGITAL OVERLOAD (FASTER) === */
        @keyframes digital-overload-winner {
            0% { transform: var(--transform-start) scale(1.2); filter: brightness(1.5); }
            10% { transform: var(--transform-start) scale(1.1) translate(0, 10px); box-shadow: 0 0 50px 20px var(--warning); filter: brightness(2); }
            30% { transform: var(--transform-start) scale(1.35) translate(0, -10px); filter: brightness(3); box-shadow: 0 0 60px 30px #fff; }
            100% { transform: translate(0, 0) scale(1.3); z-index: 200; box-shadow: 0 0 40px 15px var(--primary-magenta); filter: brightness(1.5); }
        }
        @keyframes digital-overload-loser {
            0%, 29% { transform: var(--transform-start) scale(1.2); opacity: 1; filter: none; }
            30% { transform: var(--transform-start) scale(1.2) translate(5px, -5px) rotate(3deg); filter: brightness(4) invert(1); opacity: 1; }
            40% { transform: var(--transform-start) scale(1.2) translate(-5px, 5px) rotate(-3deg); filter: brightness(2); }
            50% { transform: var(--transform-start) scale(1.25); filter: contrast(2.5); clip-path: inset(0% 0% 20% 0%); }
            75% { filter: brightness(3) blur(2px); clip-path: inset(0% 0% 60% 0%); }
            100% { transform: var(--transform-start) scale(1.1); opacity: 0; filter: brightness(1) blur(5px); clip-path: inset(0% 0% 100% 0%); }
        }
        /* ✨ CHANGE: Animation duration reduced from 1.2s to 0.9s */
        .battle-winner { animation: digital-overload-winner 0.9s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .battle-loser { animation: digital-overload-loser 0.9s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards; }
        
        /* === ABILITY ACTIVATION ANIMATIONS (NEW) === */
        @keyframes ability-hero-burst {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px var(--accent-neon-blue);
                filter: brightness(1.2);
            }
            50% {
                transform: scale(1.10);
                box-shadow: 0 0 40px 15px var(--accent-neon-blue), inset 0 0 20px var(--accent-neon-blue);
                filter: brightness(2.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px var(--accent-neon-blue);
                filter: brightness(1.2);
            }
        }

        @keyframes ability-screen-flash {
            0%, 100% { 
                filter: none; 
            }
            50% { 
                filter: brightness(1.5) contrast(1.2) saturate(0.5); 
            }
        }

        @keyframes ability-table-ripple {
            from {
                transform: scale(0);
                opacity: 0.7;
                box-shadow: 0 0 0 0px var(--accent-neon-blue);
            }
            to {
                transform: scale(1.5);
                opacity: 0;
                box-shadow: 0 0 0 80px rgba(0, 195, 255, 0);
            }
        }

        /* Classes to Activate Animations */
        .hero-ability-activated {
            animation: ability-hero-burst 0.5s ease-out forwards;
        }

        .screen-ability-flash {
            animation: ability-screen-flash 0.4s ease-in-out;
        }

        /* We will use a pseudo-element for the shockwave on the table */
        .table-ability-ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            margin-left: -50px;
            margin-top: -50px;
            border-radius: 50%;
            border: 3px solid var(--accent-neon-blue);
            animation: ability-table-ripple 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* === MODALS === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--secondary-dark-blue);
            border: 2px solid var(--primary-magenta);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
           transform: scale(1);
        }
        .modal-content h2 { font-family: 'Orbitron', serif; color: var(--primary-magenta); }
        .modal-content h3 { color: var(--primary-magenta); }
        
        /* Truco Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal .sheet {
            background: var(--secondary-dark-blue);
            border: 2px solid var(--primary-magenta);
            box-shadow: 0 0 30px var(--primary-magenta);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .sheet {
            transform: scale(1);
        }
        .modal .sheet h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-magenta);
            margin-bottom: 1rem;
        }
        .modal .sheet p {
            margin-bottom: 1.5rem;
        }
        .modal .sheet .row {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .lobby-panel {
            background-color: var(--secondary-dark-blue);
            background-image:
              linear-gradient(45deg, rgba(194, 49, 224, 0.05) 25%, transparent 25%),
              linear-gradient(-45deg, rgba(194, 49, 224, 0.05) 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, rgba(194, 49, 224, 0.05) 75%),
              linear-gradient(-45deg, transparent 75%, rgba(194, 49, 224, 0.05) 75%);
            background-size: 30px 30px;
            border: 2px solid var(--primary-magenta);
            box-shadow: 0 0 20px var(--primary-magenta);
        }
        .lobby-panel-content p {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .lobby-panel-content h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--secondary-purple);
        }

        /* === INTERACTIVITY IMPROVEMENTS === */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 15px 0px var(--accent-neon-blue);
            }
            50% {
                box-shadow: 0 0 30px 8px var(--accent-neon-blue);
            }
        }
        .glow-effect {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }

        /* === HUD ANIMATIONS === */
        @keyframes text-update-coins {
            0% { transform: scale(1); opacity: 1; }
            40% { transform: scale(1.5) rotate(-5deg); color: var(--warning); text-shadow: 0 0 12px var(--warning); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes text-update-gems {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); color: var(--accent-neon-blue); text-shadow: 0 0 8px var(--accent-neon-blue); }
            100% { transform: scale(1); }
        }

        .coin-display.updated span {
            animation: text-update-coins 0.4s ease-out;
            display: inline-block;
        }
        .gem-display.updated span {
            animation: text-update-gems 0.6s ease-in-out;
            display: inline-block;
        }

        /* === TRUCO / REVS --- SCOREBOARD AND VISUAL FEEDBACK IMPROVEMENTS === */
        @keyframes point-glow {
            0%, 100% {
                box-shadow: inset 0 0 10px rgba(107, 88, 231, 0.3);
                border-color: var(--secondary-purple);
            }
            50% {
                box-shadow: inset 0 0 15px rgba(247, 255, 0, 0.8), 0 0 20px rgba(247, 255, 0, 0.5);
                border-color: var(--warning);
            }
        }

        .point-awarded-glow {
            animation: point-glow 0.8s ease-in-out;
        }

        .player-hud {
            background: rgba(10, 31, 68, 0.4);
            border: 1px solid var(--secondary-purple);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            width: fit-content;
            margin: 0 auto;
            backdrop-filter: blur(3px);
            box-shadow: inset 0 0 10px rgba(107, 88, 231, 0.3);
            text-align: center;
        }

        .player-hud .player-name {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-blue);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .player-hud .score-trackers {
            display: flex;
            gap: 1rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
        }
        
        .trick-score-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .trick-markers {
            display: flex;
            gap: 0.3rem;
        }
        @keyframes marker-pulse { 0% { transform: scale(1); box-shadow: 0 0 8px var(--warning); } 50% { transform: scale(1.1); box-shadow: 0 0 16px var(--warning); } 100% { transform: scale(1); box-shadow: 0 0 8px var(--warning); } }

        .marker {
            width: 20px;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-blue);
            border-radius: 2px;
            opacity: 0.5;
            transition: all 0.3s ease-in-out;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }

        .marker.won {
            background-color: var(--warning);
            border-color: var(--warning);
            opacity: 1;
            box-shadow: 0 0 8px var(--warning);
            animation: marker-pulse 1.5s infinite;
        }

        /* NEW: Modal for Dory's ability */
        #dory-choice-modal .card {
            width: 90px;
            height: 126px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #dory-choice-modal .card:hover {
            transform: scale(1.1);
            border-color: var(--warning);
        }
        
        /* === REFINED LOBBY LAYOUT & COMMAND CENTER === */

        @keyframes panel-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enquadramento e Vinheta para Imersão */
        #main-lobby::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            box-shadow: inset 0 0 150px 25px rgba(10, 0, 20, 0.95);
            background: 
                radial-gradient(circle at top left, rgba(107, 88, 231, 0.15), transparent 25%),
                radial-gradient(circle at top right, rgba(107, 88, 231, 0.15), transparent 25%),
                radial-gradient(circle at bottom left, rgba(107, 88, 231, 0.15), transparent 25%),
                radial-gradient(circle at bottom right, rgba(107, 88, 231, 0.15), transparent 25%);
        }

        /* HUD Fixo no Topo (Sem alterações) */
        .player-hud-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem 1rem;
            background: linear-gradient(180deg, rgba(27, 0, 37, 0.95) 0%, rgba(43, 11, 88, 0.8) 100%);
            backdrop-filter: blur(4px);
            z-index: 1003;
            border-bottom: 1px solid var(--primary-magenta);
            box-shadow: 0 2px 15px rgba(194, 49, 224, 0.3);
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px));
        }
        .player-stats-fixed, .player-level-fixed, .player-actions-fixed {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .player-level-fixed .xp-bar-container { width: 120px; }

        /* MODIFICADO: Container principal do Lobby agora usa Grid */
        .lobby-content-area {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Coluna principal maior, painel lateral menor */
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1200px; /* Aumenta a largura máxima para o novo layout */
            height: calc(100vh - 80px); /* Ajusta a altura para descontar o HUD */
            padding: 1rem;
            gap: 2rem;
            margin-top: 80px; /* Espaço para o HUD fixo */
        }

        /* MODIFICADO: Card Principal de Ação */
        .game-card-main {
            background: linear-gradient(145deg, rgba(43, 11, 88, 0.5), rgba(15, 15, 36, 0.5));
            border-radius: 1.5rem;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            border: 2px solid var(--primary-magenta);
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 0 25px rgba(194, 49, 224, 0.4), inset 0 0 15px rgba(194, 49, 224, 0.3);
            animation: glow-primary 4s infinite;
            justify-self: center; /* Centraliza o card na sua célula do grid */
            width: 100%;
            max-width: 500px;
        }
        .game-card-main:hover {
            transform: scale(1.05);
            box-shadow: 0 0 45px rgba(194, 49, 224, 0.7), inset 0 0 20px rgba(194, 49, 224, 0.5);
        }
        .game-icon-main {
            font-size: 4rem;
            color: var(--primary-magenta);
            text-shadow: 0 0 15px var(--primary-magenta);
        }
        .game-title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--text-light);
            text-shadow: 0 0 10px var(--primary-magenta);
        }

        /* NOVO: Painel Lateral de Ações */
        .lobby-side-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(10, 31, 68, 0.4);
            border: 1px solid var(--secondary-purple);
            border-radius: 1rem;
            padding: 1.5rem;
            height: 100%;
            max-height: 550px;
            backdrop-filter: blur(5px);
            animation: panel-slide-in 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* MODIFICADO: Banner do Rebelde em Destaque (agora dentro do painel) */
        #featured-hero-banner {
            animation: none; /* Remove o brilho global para um efeito mais sutil */
            background: linear-gradient(45deg, rgba(107, 88, 231, 0.1), rgba(27,0,37,0.2));
            border: 1px solid var(--rarity-epic);
            border-radius: 0.75rem;
            padding: 1rem;
            width: 100%;
            margin-bottom: 0.5rem; /* Ajuste de margem */
            gap: 1rem;
            backdrop-filter: none;
        }
        #featured-hero-banner h3 { font-size: 1.25rem; } /* Ajusta tamanho da fonte */

        /* MODIFICADO: Botões de Ação Secundária (agora no painel) */
        .secondary-actions-grid {
            display: flex; /* Troca de grid para flex */
            flex-direction: column; /* Empilha os botões verticalmente */
            gap: 0.75rem;
            width: 100%;
        }
        .game-card-secondary {
            background: rgba(10, 31, 68, 0.6);
            border: 1px solid var(--secondary-purple);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            display: flex; /* Alinha ícone e texto */
            align-items: center;
            justify-content: flex-start; /* Alinha à esquerda */
            gap: 1rem;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: none;
        }
        .game-card-secondary:hover {
            background: rgba(43, 11, 88, 0.8);
            border-color: var(--primary-magenta);
            color: var(--primary-magenta);
            transform: translateX(10px); /* Efeito de hover mais interessante */
        }
        .game-card-secondary i { font-size: 1.5rem; }

        /* Remove o antigo botão "Leave" do corpo do lobby */
        #lobby-main-content #lobby-back-to-splash { display: none; }


        /* === MOBILE-FIRST ADAPTATIONS === */
        /* START: REPLACED BLOCK FOR MOBILE FLUIDITY */
        @media (max-width: 850px) {
            /* === GENERAL ADJUSTMENTS === */
            html, body {
                font-size: 14px; /* Slightly reduce base font size for small screens */
            }
            .splash-title {
                font-size: 2.5rem; /* Make titles smaller */
            }

            /* === LOBBY REWORK FOR MOBILE === */
            #main-lobby {
                padding-top: 5rem; /* More space for the fixed HUD */
            }
            .player-hud-fixed {
                padding: 0.5rem;
                flex-wrap: wrap; /* Allow HUD items to wrap if needed */
                justify-content: center;
                clip-path: none; /* Remove complex clip-path for mobile */
                border-radius: 0 0 15px 15px;
            }
            .player-stats-fixed, .player-level-fixed {
                gap: 0.5rem;
                font-size: 0.8rem;
            }
            /* Stack the main content and side panel vertically */
            .lobby-content-area {
                grid-template-columns: 1fr; /* Force a single column layout */
                height: auto;
                margin-top: 80px;
                padding: 1rem 0.5rem;
            }
            /* Position the side panel below the main action card */
            .lobby-side-panel {
                grid-row: 2;
                animation: none; /* Disable slide-in animation on mobile */
                max-height: none;
            }
            .game-card-main {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .game-title-main {
                font-size: 1.5rem;
            }
            .game-card-secondary:hover {
                transform: translateX(5px); /* Reduce hover effect */
            }
            
            /* === HERO SELECTION SCREEN === */
            #hero-selection-grid-container {
                grid-template-columns: 1fr; /* Stack the columns */
                gap: 1.5rem;
            }
            .hero-team-slot {
                width: 70px; /* Make team slots a bit bigger */
                height: 70px;
            }

            /* === TRUCO SCREEN: FULL MOBILE REWORK (MODIFIED FOR COMPACTNESS) === */
            #truco-screen {
                display: flex; /* Switch from Grid to Flexbox for vertical stacking */
                flex-direction: column;
                height: 100vh; /* Use full viewport height */
                width: 100vw;  /* Use full viewport width */
                padding: 0.25rem; /* MODIFIED: Reduced padding */
                gap: 0;
                overflow: hidden; /* Prevent scrolling */
            }

            /* Hide the desktop sidebar completely */
            #truco-sidebar {
                display: none;
            }

            /* Make the main game area fill the entire screen */
            .truco-main-area {
                height: 100%;
                width: 100%;
                display: flex; /* Use Flexbox to structure the content */
                flex-direction: column;
            }
            .truco-table {
                padding: 0.25rem; /* MODIFIED: Reduced padding */
                height: 100%;
                width: 100%;
                flex-grow: 1; /* Allow the table to fill available space */
                aspect-ratio: unset; /* Remove fixed aspect ratio */
                gap: 0.25rem; /* MODIFIED: Reduced gap */
                grid-template-rows: auto 1fr auto; /* Let rows size themselves */
            }

            /* Adjust player areas and card sizes for smaller screens */
            .player-area {
                gap: 0.25rem; /* MODIFIED: Reduced gap */
            }
            .hand {
                min-height: 80px; /* MODIFIED: Reduced hand height */
            }
            /* MODIFIED: Cards are smaller and overlap more */
            #truco-screen .card, .hand .card {
                width: 60px;
                height: 84px;
                margin: 0 -15px;
                padding: 4px;
            }
            /* MODIFIED: Smaller font sizes on cards */
            #truco-screen .card .rank { font-size: 1.2rem; }
            #truco-screen .card .suit { font-size: 1rem; }
            .table-slot {
                width: 65px;
                height: 90px;
            }

            /* Position the player's area at the bottom for thumb access */
            #player-area {
                display: flex;
                flex-direction: column;
                justify-content: flex-end; /* Push hand and actions down */
            }

            #truco-actions {
                padding: 0.25rem 0; /* MODIFIED: Reduced padding */
                width: 100%;
                flex-wrap: wrap; /* Allow buttons to wrap on small screens */
                justify-content: center;
                gap: 0.25rem; /* MODIFIED: Reduced gap */
            }
            /* MODIFIED: Smaller action buttons */
            #truco-actions .btn-primary, #truco-actions .btn-special, #truco-actions .btn-danger, #truco-actions .btn-success {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }


            /* ✨ NEW: Styles for the mobile-specific ability buttons */
            #mobile-hero-abilities {
                display: flex; /* This will be a new empty div in your HTML */
                justify-content: center;
                gap: 0.5rem; /* MODIFIED: Reduced gap */
                margin-bottom: 0.25rem; /* MODIFIED: Reduced margin */
                height: 45px; /* MODIFIED: Reduced height */
            }
            .ability-button-mobile {
                width: 40px; /* MODIFIED: Reduced size */
                height: 40px; /* MODIFIED: Reduced size */
                border-radius: 50%;
                border: 2px solid var(--secondary-purple);
                background-color: var(--primary-dark);
                background-size: cover;
                background-position: center;
                transition: all 0.2s;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            .ability-button-mobile:disabled {
                filter: grayscale(1) brightness(0.5);
                cursor: not-allowed;
            }
            /* Re-use the cool glow effect from the sidebar */
            .ability-button-mobile.ability-ready-glow {
                animation: pulse-glow-ability 2s infinite ease-in-out;
                border-color: var(--accent-neon-blue);
            }

            /* Tweak HUD fonts and markers for mobile */
            .player-hud {
                padding: 0.2rem 0.4rem; /* MODIFIED: Reduced padding */
            }
            .player-hud .player-name { font-size: 0.75rem; } /* MODIFIED: Smaller font */
            .player-hud .score-trackers { font-size: 0.7rem; gap: 0.4rem;} /* MODIFIED: Smaller font and gap */
            .marker { width: 12px; } /* MODIFIED: Smaller marker */
        }
        /* END: REPLACED BLOCK FOR MOBILE FLUIDITY */

    </style>
</head>
<body>
    
    <div id="sound-control" title="Toggle Music"><i class='bx bxs-volume-mute'></i></div>
    <div id="particle-container"></div>
    <div id="notification" role="alert" aria-live="polite"></div>
    <div id="flying-coin-container" class="flying-coin-container"></div>
    <div id="truco-text-overlay"></div>
    <button id="missions-toggle-btn" title="Daily Contracts" class="btn-special" style="position: fixed; bottom: 20px; right: 20px; z-index: 1001; border-radius: 999px; width: 60px; height: 60px; padding: 0; display: none; justify-content: center; align-items: center;"><i class='bx bx-trophy text-3xl'></i></button>
    
    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="tutorial-title"></h2>
            <div id="tutorial-body" class="text-left"></div>
            <button id="close-tutorial-modal" class="btn-primary w-full mt-4">Got it!</button>
        </div>
    </div>
    
    <div id="mode-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl mb-4">Choose Game Mode</h2>
            <p class="text-slate-400 mb-6">How will you fight for the rebellion today?</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="btn-select-revs" class="btn-primary flex-1">
                    <h3 class="text-lg">Revs (Standard)</h3>
                    <p class="text-xs font-normal normal-case">Strategic battle up to 12 points. Use your complete Cell.</p>
                </button>
                <button id="btn-select-iron-hand" class="btn-special flex-1">
                    <h3 class="text-lg">Iron Hand</h3>
                    <p class="text-xs font-normal normal-case">Best-of-3 hands, all or nothing. Play blind. Requires 500 Coins.</p>
                </button>
            </div>
             <button id="close-mode-selection-modal" class="btn-danger w-full mt-6">Back to Lobby</button>
        </div>
    </div>

    <div id="dory-choice-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl mb-4">Distort Fate</h2>
            <p class="text-slate-400 mb-6">Inspect the threads of fate. Choose one of the realities below to become the new **Trump Card**.</p>
            <div id="dory-card-choices" class="flex gap-4 justify-center">
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title" class="text-2xl mb-4 text-yellow-400">Leave Arena?</h2>
            <p id="confirm-body" class="text-slate-400 mb-6">If you leave now, you will forfeit any rewards and mission progress from this match.</p>
            <div class="flex gap-4 justify-center">
                <button id="btn-cancel-action" class="btn-primary">Cancel</button>
                <button id="btn-confirm-action" class="btn-danger">Leave</button>
            </div>
        </div>
    </div>


    <div id="splash-screen" class="screen">
        <img src="https://i.imgur.com/ARHJ81Q.png" alt="Rebellion Logo" class="splash-logo">
        <h1 class="splash-title">PROJECT REVS</h1>
        <p class="text-sm sm:text-base text-slate-400 mb-8">Your journey of strategy and rebellion begins now.</p>
        <button id="btn-enter-lobby" class="btn-primary focus:ring">Join the Resistance</button>
    </div>

    <div id="main-lobby" class="screen hidden">

        <div class="player-hud-fixed">
            <div class="player-stats-fixed">
                <div class="currency-display coin-display"><i class='bx bx-chip'></i><span id="player-coins"></span></div>
                <div class="currency-display gem-display"><i class='bx bxs-credit-card-front'></i><span id="player-gems"></span></div>
            </div>
            <div class="player-level-fixed">
                <div class="level-badge">Level <span id="player-level"></span></div>
                <div class="xp-bar-container"><div id="player-xp-bar" class="xp-bar-fill"></div></div>
            </div>
            <div class="player-actions-fixed">
                <button id="main-tutorial-btn" class="btn-special rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold p-0 ml-2" title="Mission Briefing">?</button>
                <button id="lobby-back-to-splash" class="btn-danger rounded-full w-8 h-8 flex items-center justify-center text-lg p-0 ml-2" title="Leave the Resistance"><i class='bx bx-power-off'></i></button>
            </div>
        </div>
    
        <div id="lobby-main-content" class="lobby-content-area">
    
            <div role="button" tabindex="0" class="game-card-main" id="nav-truco">
                <i class='bx bx-game game-icon-main'></i>
                <h3 class="game-title-main">CLANDESTINE ARENA</h3>
                <p>Glory and resources await you. Fight for the rebellion!</p>
                <button class="btn-special w-full mt-4" tabindex="-1">ENTER THE ARENA</button>
            </div>
    
            <div class="lobby-side-panel">
                <div id="featured-hero-banner" class="featured-hero-banner">
                </div>
    
                <div class="secondary-actions-grid">
                    <div role="button" tabindex="0" class="game-card-secondary" id="nav-gacha">
                        <i class='bx bx-network-chart'></i>
                        <span>Recruit</span>
                    </div>
                    <div role="button" tabindex="0" class="game-card-secondary" id="nav-heroes">
                        <i class='bx bx-group'></i>
                        <span>My Rebels</span>
                    </div>
                    <div role="button" tabindex="0" class="game-card-secondary" id="nav-lore">
                        <i class='bx bx-book-open'></i>
                        <span>Files</span>
                    </div>
                </div>
            </div>
            
        </div>
    
        <div id="lobby-briefing-panel" class="w-full max-w-4xl flex-col items-center hidden p-4 rounded-lg lobby-panel">
            <h2 id="briefing-title" class="splash-title mb-4 text-4xl">Mission Briefing</h2>
            <div id="lobby-briefing-content" class="lobby-panel-content text-left p-6 bg-black/30 rounded-lg w-full"></div>
            <div class="flex gap-4">
                <button id="close-lobby-briefing" class="btn-primary mt-6">Continue...</button>
                <button id="briefing-action-btn" class="btn-special mt-6 hidden">Action</button>
            </div>
        </div>
    
        <div id="missions-container">
            <button id="close-missions-btn" class="absolute top-2 right-3 text-2xl text-slate-400 hover:text-white">&times;</button>
            <h3 class="text-lg font-bold text-yellow-400 mb-2 font-['Orbitron']">Daily Contracts</h3>
            <div id="missions-list"></div>
        </div>
    </div>
    
    <div id="gacha-screen" class="screen hidden">
        <div class="gacha-container">
            <h1 class="splash-title">Recruitment</h1>
            <div class="gacha-result-area">
                <div id="gacha-card-shuffler" class="gacha-card-shuffler"></div>
                <div id="gacha-card" class="gacha-card hidden">
                    <img id="gacha-hero-img" src="" alt="">
                    <p id="gacha-rarity" class="gacha-rarity"></p>
                    <h2 id="gacha-hero-name" class="gacha-hero-name"></h2>
                    <p id="gacha-hero-ability" class="gacha-hero-ability"></p>
                </div>
                <div id="gacha-placeholder" class="gacha-placeholder">?</div>
            </div>
            <div class="flex flex-col items-center gap-2">
                <button id="btn-summon-hero" class="btn-special">
                    <span class="flex items-center gap-2"><i class='bx bx-user-plus'></i> Recruit Rebel (10 <i class='bx bxs-credit-card-front'></i>)</span>
                </button>
                <button id="gacha-back-to-lobby" class="btn-danger mt-4">Back</button>
            </div>
        </div>
    </div>

    <div id="hero-management-screen" class="screen hidden">
        <h1 class="splash-title mb-4">My Rebels</h1>

        <div id="hero-management-controls" class="w-full max-w-4xl mb-4 flex flex-wrap justify-center items-center gap-4 p-2 bg-black/20 rounded-lg border border-secondary-purple">
            <div class="flex gap-2" id="faction-filters">
                <button data-filter="all" class="btn-special text-xs py-1 px-3 active">All</button>
                <button data-filter="Arcane" class="btn-special text-xs py-1 px-3">Arcane</button>
                <button data-filter="Wild" class="btn-special text-xs py-1 px-3">Wild</button>
                <button data-filter="Shadow" class="btn-special text-xs py-1 px-3">Shadow</button>
            </div>
            <div class="flex items-center gap-2">
                <label for="hero-sort" class="font-bold text-sm">Sort by:</label>
                <select id="hero-sort" class="bg-primary-dark border border-secondary-purple rounded p-1 text-sm">
                    <option value="name">Name</option>
                    <option value="rarity">Rarity</option>
                    <option value="level">Level</option>
                </select>
            </div>
        </div>

        <div id="management-hero-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full max-w-4xl"></div>
         <div class="flex gap-4 mt-4">
             <button id="management-back-to-lobby" class="btn-danger">Back</button>
             <button id="nav-heroes-to-selection" class="btn-primary">Assemble Cell</button>
        </div>
    </div>


    <div id="hero-selection-screen" class="screen hidden">
        <h1 class="splash-title mb-4">Assemble Your Cell</h1>
        <p class="text-slate-400 mb-4">Choose your philosophy. Select one Rebel from each category.</p>
        
        <div id="hero-selection-grid-container">
            <div id="passive-selection" class="hero-selection-column passive-column">
                <h3>Passive Core</h3>
            </div>
            <div id="hybrid-selection" class="hero-selection-column hybrid-column">
                <h3>Hybrid Style</h3>
            </div>
            <div id="active-selection" class="hero-selection-column active-column">
                <h3>Active Trump</h3>
            </div>
        </div>
        
        <div class="flex flex-col items-center gap-4 w-full max-w-lg mt-6">
            <h2 class="text-xl font-bold text-yellow-400">Your Chosen Cell</h2>
            <div id="selected-hero-team" class="flex justify-center gap-4 mb-4">
                <div class="hero-team-slot" data-slot="passive">?</div>
                <div class="hero-team-slot" data-slot="hybrid">?</div>
                <div class="hero-team-slot" data-slot="active">?</div>
            </div>
            <div class="flex gap-4">
                <button id="selection-back-to-lobby" class="btn-danger">Back</button>
                <button id="btn-confirm-team" class="btn-primary" disabled>Confirm Cell</button>
            </div>
        </div>
    </div>
    
    <div id="truco-screen" class="screen hidden">
        <div id="truco-sidebar" class="w-full md:w-80 bg-black bg-opacity-20 p-4 flex flex-col gap-4 rounded-xl border border-purple-900 transition-all duration-500">
            <div class="flex justify-between items-center border-b-2 border-yellow-400/30 pb-2">
                <h2 class="text-2xl font-bold text-yellow-400 font-['Orbitron']">Your Cell</h2>
                <div class="flex items-center gap-2 text-xl" style="color: var(--accent-neon-blue);">
                    <i class='bx bxs-zap'></i>
                    <b id="player-charge">0</b>
                </div>
            </div>
            <div id="truco-hero-info" class="flex flex-col gap-4 mt-4 flex-grow"></div>
            <button id="truco-back-to-lobby" class="btn-danger w-full mt-4">Leave Arena</button>
        </div>
        <div class="truco-main-area">
            <div id="battle-arena" class="absolute inset-0 flex justify-center items-center pointer-events-none z-50"></div>
            <div id="truco-banter-box" aria-live="polite"></div>
            <div class="truco-table">
                <div class="player-area" id="ai-area">
                    <div class="player-hud opponent-hud">
                        <div class="player-name">Corporation</div>
                        <div class="score-trackers">
                            <span><span id="score-label-ai">Points:</span> <b id="ptsAI">0</b></span>
                            <div class="trick-score-container" id="trick-container-ai">
                                <span>Rounds:</span>
                                <div class="trick-markers" id="trick-markers-ai">
                                    <div class="marker"></div>
                                    <div class="marker"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hand" id="handAI"></div>
                </div>

                <div class="table-center">
                    <div class="table-slot" id="slotAI"></div>
                    <div class="vira-container">
                        <div class="badge">TRUMP</div>
                        <div id="vira-card-slot"></div>
                        <div class="hud mt-2">
                            <div class="badge">Hand Stake: <b id="handStake">1</b></div>
                        </div>
                        <div class="badge mt-2" id="status" aria-live="polite"></div>
                    </div>
                    <div class="table-slot" id="slotYou"></div>
                </div>

                <div class="player-area" id="player-area">
                    <div class="hand" id="handYou"></div>
                    <div class="player-hud player-hud-you">
                        <div class="player-name">Your Cell</div>
                        <div class="score-trackers">
                            <span><span id="score-label-you">Points:</span> <b id="ptsYou">0</b></span>
                            <div class="trick-score-container" id="trick-container-you">
                                <span>Rounds:</span>
                                <div class="trick-markers" id="trick-markers-you">
                                    <div class="marker"></div>
                                    <div class="marker"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="mobile-hero-abilities" class="md:hidden"></div>
                    <div id="truco-actions">
                         <div id="decision-timer-container" class="hidden absolute bottom-full w-64 h-2 bg-red-900 rounded overflow-hidden">
                              <div id="decision-timer-bar" class="h-full bg-danger transition-all duration-100 ease-linear"></div>
                         </div>
                         <button id="btnConfirmPlay" class="btn-primary hidden">Confirm</button>
                         <button id="btnCancelPlay" class="btn-danger hidden">Cancel</button>
                         <button id="btnTruco" class="btn-special">Revolution</button>
                         <button id="btnRun" class="btn-danger hidden">Run</button>
                         <button id="btnAccept" class="btn-success hidden">Accept</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="modalEndGame">
            <div class="sheet">
                <h2 id="endGameTitle"></h2><p id="endGameText"></p>
                <div class="row" style="justify-content:flex-end"><button id="btnNewMatch" class="btn-primary">Play Again</button></div>
            </div>
        </div>
        <div class="modal" id="modalEndHand">
            <div class="sheet">
                <h2 id="endHandTitle"></h2>
                <p id="endHandText"></p>
                <div class="row" style="justify-content:flex-end">
                    <button id="btnBackToLobbyFromTruco" class="btn-danger">Back to Lobby</button>
                    <button id="btnNextHand" class="btn-primary">Next Hand</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // =================================================================================
    // GAME CONSTANTS MODULE
    // =================================================================================
    const CONSTANTS = {
        INITIAL_PLAYER_COINS: 1500,
        INITIAL_PLAYER_GEMS: 20,
        INITIAL_XP_TO_NEXT_LEVEL: 100,
        LEVEL_UP_COIN_MULTIPLIER: 100,
        GACHA_COST: 10,
        EVOLVE_BASE_COST: 200,
        IRON_HAND_COST: 500,
        IRON_HAND_REWARDS: { coins: 1500, xp: 100, gems: 1 },
        MATCH_WIN_XP: 50,
        MATCH_WIN_COINS: 250,
        DECISION_TIMER_SECONDS: 4,
        // ✨ MUDANÇA: Novas constantes para incentivos
        MATCH_COMPLETION_COINS: 75,
        MATCH_COMPLETION_XP: 20,
        TRICK_WIN_XP: 1,
    };

    // =================================================================================
    // PLAYER DATA MODULE
    // =================================================================================
    const PlayerData = {
        data: {
            coins: CONSTANTS.INITIAL_PLAYER_COINS, 
            gems: CONSTANTS.INITIAL_PLAYER_GEMS, 
            level: 1, 
            xp: 0, 
            xpToNextLevel: CONSTANTS.INITIAL_XP_TO_NEXT_LEVEL,
            rebels: { 
                echo: { level: 1, duplicates: 0 }, 
                gaia: { level: 1, duplicates: 0 }, 
                silo: { level: 1, duplicates: 0 } 
            },
            missions: { progress: {}, lastReset: new Date().toDateString() }
        },
        init() {
            const s = localStorage.getItem('playerData_revs_v2'); // Updated version
            if(s) { this.data = JSON.parse(s); }
            if(!this.data.missions) { this.data.missions = { progress: {}, lastReset: new Date().toDateString() }; }
            if(!this.data.rebels || Object.keys(this.data.rebels).length < 3) { 
                this.data.rebels = { 
                    echo: { level: 1, duplicates: 0 }, 
                    gaia: { level: 1, duplicates: 0 }, 
                    silo: { level: 1, duplicates: 0 } 
                }; 
            }
            if(this.data.missions.lastReset !== new Date().toDateString()) {
                this.data.missions = { progress: {}, lastReset: new Date().toDateString() };
            }
            this.save();
            this.updateUI();
        },
        save() { localStorage.setItem('playerData_revs_v2', JSON.stringify(this.data)); },
        addCoins(a, sourceElement) {
            this.data.coins += a;
            if (a > 0) SoundManager.playCoinGain();
            this.updateUI();
            this.save();
        },
        addGems(a, sourceElement) {
            this.data.gems += a;
             if (a > 0) SoundManager.playGemGain();
            this.updateUI();
            this.save();
        },
        addXP(a) {
            this.data.xp += a;
            while(this.data.xp >= this.data.xpToNextLevel) {
                this.data.xp -= this.data.xpToNextLevel;
                this.levelUp();
            }
            this.updateUI();
            this.save();
        },
        levelUp() {
            this.data.level++;
            this.data.xpToNextLevel = Math.floor(this.data.xpToNextLevel * 1.5);
            this.addCoins(this.data.level * CONSTANTS.LEVEL_UP_COIN_MULTIPLIER);
            SoundManager.playLevelUp();
        },
        addHero(heroId) {
            if(!this.data.rebels[heroId]) {
                this.data.rebels[heroId] = { level: 1, duplicates: 0 };
            } else {
                this.data.rebels[heroId].duplicates++;
            }
            this.save();
        },
        updateUI() {
            const updateAndAnimate = (elementId, value) => {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = value;
                    const parent = el.closest('.currency-display') || el;
                    parent.classList.add('updated');
                    setTimeout(() => parent.classList.remove('updated'), 400); // Animation duration
                }
            };

            updateAndAnimate('player-coins', this.data.coins.toLocaleString());
            updateAndAnimate('player-gems', this.data.gems.toLocaleString());

            document.getElementById('player-level').textContent = this.data.level;
            const xpBar = document.getElementById('player-xp-bar');
            if (xpBar) {
                xpBar.style.width = `${(this.data.xp / this.data.xpToNextLevel) * 100}%`;
            }
            if (window.MissionsManager) MissionsManager.updateUI();
        },
        trackMission(missionType, amount = 1) {
            if (!this.data.missions.progress[missionType]) {
                this.data.missions.progress[missionType] = 0;
            }
            this.data.missions.progress[missionType] += amount;
            this.save();
            MissionsManager.updateUI();
        }
    };

    // =================================================================================
    // UI AND SOUND MODULE
    // =================================================================================
    const UIManager = {
        init() {
            document.getElementById('close-tutorial-modal').addEventListener('click', () => { SoundManager.playUIClick(); this.hideModal('tutorial-modal'); });
            document.getElementById('tutorial-modal').addEventListener('click', (e) => {
                if (e.target.id === 'tutorial-modal') { SoundManager.playUIClick(); this.hideModal('tutorial-modal'); }
            });
             document.getElementById('close-mode-selection-modal').addEventListener('click', () => { SoundManager.playUIClick(); this.hideModal('mode-selection-modal'); });
            document.getElementById('mode-selection-modal').addEventListener('click', (e) => {
                if (e.target.id === 'mode-selection-modal') { SoundManager.playUIClick(); this.hideModal('mode-selection-modal'); }
            });

            document.getElementById('main-tutorial-btn').addEventListener('click', () => { SoundManager.playUIClick(); this.showTutorial('welcome'); });
            
            document.getElementById('close-lobby-briefing').addEventListener('click', () => {
                SoundManager.playUIClick();
                this.toggleLobbyBriefing(false);
            });
            
            document.getElementById('briefing-action-btn').addEventListener('click', () => {
                SoundManager.playUIClick();
                this.toggleLobbyBriefing(false);
                UIManager.showModal('mode-selection-modal');
            });

            const missionsToggle = document.getElementById('missions-toggle-btn');
            const missionsContainer = document.getElementById('missions-container');
            const closeMissionsBtn = document.getElementById('close-missions-btn');

            if (missionsToggle && missionsContainer) {
                missionsToggle.addEventListener('click', () => {
                    SoundManager.playUIClick();
                    missionsContainer.classList.toggle('show');
                });
            }
             if (closeMissionsBtn && missionsContainer) {
                closeMissionsBtn.addEventListener('click', () => {
                    SoundManager.playUIClick();
                    missionsContainer.classList.remove('show');
                });
            }
        },
        showNotification(msg, type = 'info') { const n = document.getElementById('notification'); let i = 'bx-info-circle'; if (type === 'coin') i = 'bx-chip'; if (type === 'gem') i = 'bxs-credit-card-front'; if (type === 'level') i = 'bx-trophy'; if (type === 'hero') i = 'bx-user-plus'; if (type === 'charge') i = 'bxs-zap'; if(type === 'danger') i = 'bx-error'; n.innerHTML = `<i class='bx ${i}'></i> <span>${msg}</span>`; n.classList.add('show'); setTimeout(() => { n.classList.remove('show'); }, 3000); },
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('show');
        },
        hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.remove('show');
        },
        toggleLobbyBriefing(show) {
            document.getElementById('lobby-main-content').classList.toggle('hidden', show);
            document.getElementById('lobby-briefing-panel').classList.toggle('hidden', !show);
        },
        // ✨ NEW: Function to show hero ability details
        showHeroDetails(hero) {
            const modal = document.getElementById('tutorial-modal');
            const title = document.getElementById('tutorial-title');
            const body = document.getElementById('tutorial-body');

            title.textContent = `${hero.name} - Upgrades`;

            let bodyHTML = `<p class="mb-4">${hero.lore}</p>`;
            if (hero.upgrades && hero.upgrades.length > 0) {
                hero.upgrades.forEach((upgrade, index) => {
                    bodyHTML += `
                        <div class="p-2 mb-2 rounded ${PlayerData.data.rebels[hero.id]?.level > index ? 'bg-green-900/50' : 'bg-black/30'}">
                           <h4 class="font-bold text-yellow-400">Level ${index + 1}</h4>
                           <p class="text-sm">${upgrade}</p>
                        </div>
                    `;
                });
            } else {
                bodyHTML += `<p>${hero.ability.base}</p><p class="mt-4 text-slate-400">This rebel has no further upgrades.</p>`;
            }

            body.innerHTML = bodyHTML;
            this.showModal('tutorial-modal');
        },
        showTutorial(game) {
            const briefingTitle = document.getElementById('briefing-title');
            const contentContainer = document.getElementById('lobby-briefing-content');
            const closeBtn = document.getElementById('close-lobby-briefing');
            const actionBtn = document.getElementById('briefing-action-btn');
            
            const modal = document.getElementById('tutorial-modal');
            const title = document.getElementById('tutorial-title');
            const body = document.getElementById('tutorial-body');
            
            const trucoContent = `
                <div>
                    <h3>The Mission</h3>
                    <p>The objective is simple: be the first to accumulate **12 Influence Points** and dominate the network. The match is divided into "hands," and each hand is initially worth 1 Influence Point.</p>
                    <h3>The Arsenal: Protocols and Hierarchy</h3>
                    <h4>1. The "Target" (Trump Card) and the "Key Protocols" (Strongest Cards)</h4>
                    <p>At the beginning of each hand, a card is revealed on the table. This is the **"Target" (the Trump Card)**.</p>
                    <p>The four cards with the value **immediately above** the Target become the **"Key Protocols" (the Strongest Cards)**, the most powerful of that round.</p>
                    <p><i>Example: If the Target is a 7, all Queens (Q) are the Key Protocols.</i></p>
                    <p>The hierarchy among the Key Protocols is defined by the suit, in this order (from weakest to strongest): Diamonds (♦️) < Spades (♠️) < Hearts (♥️) < Clubs (♣️).</p>
                    <h4>2. Ranking of Standard Protocols</h4>
                    <p>Protocols that are not "Key" have the following order of strength: 4 < 5 < 6 < 7 < Queen (Q) < Jack (J) < King (K) < Ace (A) < 2 < 3.</p>
                    <h3>The Flow of a Hand</h3>
                    <p>Whoever wins two of the three "rounds" (or "tricks") wins the entire hand and captures the Influence Points.</p>
                    <h3>The Soul of the Rebellion: Starting a "Revolution!"</h3>
                    <p>On your turn, you can call a **"REVOLUTION!"**. This raises the hand's stake to **3 Points**. The opponent can Run (you win 1 point), Accept (the hand is worth 3), or Raise the bet.</p>
                </div>
            `;

            if (game === 'welcome') {
                briefingTitle.textContent = "Mission Briefing";
                contentContainer.innerHTML = `
                    <h3>Year 3025</h3>
                    <p>Outside the capital, wealth and prestige belong only to those who defy the system.</p>
                    <p>You are a strategist for the resistance, and your weapon is <b style="color: var(--primary-magenta);">Revs</b>, the clandestine game that funds the rebellion. At hidden tables, every victory is a small revenge against the elite.</p>
                    <p>On the horizon, the legendary tournament <b style="color: var(--rarity-legendary); text-shadow: 0 0 5px var(--rarity-legendary);">"The Revolution"</b> approaches. To win, you will need to recruit the best <b style="color: var(--accent-blue);">Rebels</b> — specialists with unique abilities.</p>
                    <p class="font-bold mt-4">Assemble your cell. Dominate the table. This is your chance to turn the tables and rewrite history.</p>
                `;
                closeBtn.textContent = 'Continue...';
                actionBtn.classList.add('hidden');
                this.toggleLobbyBriefing(true);
                return;
            }
            
            if (game === 'truco-briefing') {
                briefingTitle.textContent = "Revs Field Manual";
                contentContainer.innerHTML = trucoContent;
                closeBtn.textContent = 'Back to Lobby';
                actionBtn.textContent = 'Enter Arena';
                actionBtn.classList.remove('hidden');
                this.toggleLobbyBriefing(true);
                return;
            }

            if (game === 'lore') {
                briefingTitle.textContent = "Rebellion Files";
                contentContainer.innerHTML = `
                    <h3>Why We Fight</h3>
                    <p>Each match of <b style="color: var(--primary-magenta);">Revs</b> in the Clandestine Arena is not just a game; it's an act of rebellion. Winning grants you <b style="color: var(--text-light);">Coins</b> to fund your operations and <b style="color: var(--accent-blue);">XP</b> to hone your skills as a leader.</p>
                    <h3>The Rebellion Cycle</h3>
                    <p><b>1. Recruit Rebels:</b> Use <b style="color: var(--primary-magenta);">Chips</b> (earned in special modes and missions) in the Recruitment area. Each Chip can bring a new specialist to your cause, each with unique abilities.</p>
                    <p><b>2. Manage and Upgrade:</b> In 'My Rebels', you can view your team. Finding duplicates of a rebel allows you to upgrade them, unlocking more powerful versions of their abilities.</p>
                    <h3>Assemble Your Cell (1-1-1 Rule)</h3>
                    <p>Before each Revs match, you will assemble a cell. The rule is simple and strategic: your team of three must consist of **one Passive Rebel, one Hybrid Rebel, and one Active Rebel**. This choice defines your team's core strategy, your playstyle, and your ultimate trump card.</p>
                `;
                closeBtn.textContent = 'Close';
                actionBtn.classList.add('hidden');
                this.toggleLobbyBriefing(true);
                return;
            }
            
            if (game === 'truco') {
                title.textContent = 'Revs Field Manual';
                body.innerHTML = trucoContent;
            }

            modal.classList.add('show');
        }
    };
    const SoundManager = {
        isInitialized: false, isMuted: true, synths: {}, music: null,
        initialize() {
            if (this.isInitialized) return;
            Tone.start();
            const volume = new Tone.Volume(-12).toDestination();
            const reverb = new Tone.Reverb(0.5).connect(volume);
            
            this.synths.uiClick = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).connect(volume);
            this.synths.screenTransition = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).connect(new Tone.Filter(1000, "lowpass").connect(volume));
            this.synths.coinGain = new Tone.PluckSynth({attackNoise: 0.5, resonance: 0.8}).connect(volume);
            this.synths.gemGain = new Tone.FMSynth({ harmonicity: 2, modulationIndex: 5, modulationEnvelope: { attack: 0.01, decay: 0.3 } }).connect(reverb);
            this.synths.levelUp = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 0.5 } }).connect(volume);
            this.synths.summonStart = new Tone.AMSynth({ harmonicity: 1.5, envelope: { attack: 0.5, decay: 1, sustain: 0.5, release: 1 }, modulation: { type: "sine" } }).connect(reverb);
            this.synths.summonReveal = new Tone.MetalSynth({ frequency: 150, envelope: { attack: 0.001, decay: 0.6, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).connect(volume);
            this.synths.cardDeal = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0 } }).connect(volume);
            this.synths.trickWin = new Tone.PolySynth(Tone.Synth).connect(volume);
            this.synths.trickLose = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 1.2, modulationIndex: 10 }).connect(volume);
            this.synths.cardSlam = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.08, sustain: 0 } }).connect(volume);
            this.synths.manilhaSlam = new Tone.PluckSynth({ attackNoise: 1, damping: 4000, resonance: 0.9 }).connect(volume);
            this.synths.trucoSting = new Tone.FMSynth({ harmonicity: 0.5, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.5, release: 0.5 } }).connect(new Tone.Filter(300, "lowpass").connect(volume));
            this.synths.abilityActivate = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 } }).connect(new Tone.Filter(800, "lowpass").connect(volume));
            this.synths.rewardClaim = new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).connect(volume);
            this.synths.naturesGrasp = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.1 } }).connect(new Tone.Filter(400, "lowpass").connect(volume));
            this.synths.cardShatter = new Tone.MetalSynth({frequency: 400, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, harmonicity: 8.1, modulationIndex: 40, resonance: 8000, octaves: 1.5}).connect(volume);
            this.synths.cardGlitch = new Tone.FMSynth({harmonicity: 3, modulationIndex: 1, modulation: {type: 'square'}, envelope: {attack: 0.01, decay: 0.1}}).connect(volume);
            
            // ✨ NOVO: Synths para o som da "Revolução"
            this.synths.systemBreach = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.001, decay: 0.15, sustain: 0 } }).connect(new Tone.Filter(200, "lowpass").connect(volume));
            this.synths.bassDrop = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 2, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }, }).connect(volume);

            const musicVolume = new Tone.Volume(-24).connect(volume);
            const filter = new Tone.AutoFilter("4n").connect(musicVolume).start();
            this.music = new Tone.Loop(time => {
                const synth = new Tone.DuoSynth({
                    vibratoAmount: 0.1,
                    vibratoRate: 5,
                    harmonicity: 1.5,
                    voice0: { volume: -10, portamento: 0, oscillator: { type: "fatsawtooth" }, filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 } },
                    voice1: { volume: -10, portamento: 0, oscillator: { type: "fatsquare" }, filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 } }
                }).connect(filter);
                const notes = ["C2", "G2", "Eb2", "Bb2"];
                synth.triggerAttackRelease(notes[Math.floor(Math.random() * notes.length)], "1n", time);
            }, "1m").start(0);

            this.isInitialized = true;
        },
        
        _play(synth, ...args) { if(!this.isInitialized) this.initialize(); if(this.isMuted) return; synth.triggerAttackRelease(...args); },
        playUIClick() { if(!this.isInitialized) this.initialize(); if(this.isMuted) return; this.synths.uiClick.triggerAttackRelease("C5", "8n"); },
        playScreenTransition() { if(!this.isInitialized) this.initialize(); if(this.isMuted) return; this.synths.screenTransition.triggerAttackRelease("16n"); },
        playCoinGain() { const now = Tone.now(); this._play(this.synths.coinGain, "C5", "16n", now); this._play(this.synths.coinGain, "E5", "16n", now + 0.1); this._play(this.synths.coinGain, "G5", "16n", now + 0.2);},
        playGemGain() { this._play(this.synths.gemGain, "A5", "4n"); },
        playLevelUp() { const now = Tone.now(); this._play(this.synths.levelUp, ["C4", "E4", "G4"], "2n", now); this._play(this.synths.levelUp, ["G4", "B4", "D5"], "2n", now + 0.2); },
        playSummonStart() { this._play(this.synths.summonStart, "C3", "2n"); },
        playSummonReveal(rarity) { let note = "C4"; if (rarity === 'Rare') note = "G4"; if (rarity === 'Epic') note = "C5"; if (rarity === 'Legendary') note = "G5"; this._play(this.synths.summonReveal, note, "4n"); },
        playCardDeal() { if(!this.isInitialized) this.initialize(); if(this.isMuted) return; this.synths.cardDeal.triggerAttackRelease("32n"); },
        playTrickWin() { const now = Tone.now(); this._play(this.synths.trickWin, ["C5", "E5", "G5", "C6"], "8n", now); },
        playTrickLose() { const now = Tone.now(); this._play(this.synths.trickLose, ["C3", "C#3"], "4n", now); },
        playCardSlam() { if(!this.isInitialized) this.initialize(); if(this.isMuted) return; this.synths.cardSlam.triggerAttack(); },
        playManilhaSlam() { this._play(this.synths.manilhaSlam, "C5", "8n"); },
        playTrucoSting() { this._play(this.synths.trucoSting, "C2", "2n"); },
        playAbilityActivate() { this._play(this.synths.abilityActivate, "G5", "16n"); },
        playRewardClaim() { this._play(this.synths.rewardClaim, "C6", "8n", Tone.now(), 0.8); },
        playNaturesGrasp() { this._play(this.synths.naturesGrasp, "8n"); },
        playCardShatter() { this._play(this.synths.cardShatter, "C4", "8n"); },
        playCardGlitch() { this._play(this.synths.cardGlitch, "G#2", "16n"); },
        
        // ✨ NOVO: Som de impacto da "Revolução"
        playSystemBreach() {
            if (!this.isInitialized) this.initialize();
            if (this.isMuted) return;
            const now = Tone.now();
            this.synths.systemBreach.triggerAttack(now);
            this.synths.uiClick.triggerAttackRelease("G6", "32n", now + 0.01);
            this.synths.bassDrop.triggerAttackRelease("C1", "8n", now);
        },
        
        toggleMute() { 
            this.isMuted = !this.isMuted; 
            document.querySelector('#sound-control i').className = this.isMuted ? 'bx bxs-volume-mute' : 'bx bxs-volume-full'; 
            if (!this.isMuted && !this.isInitialized) { this.initialize(); }
            if (this.isInitialized) { Tone.Transport.state === 'started' && this.isMuted ? Tone.Transport.pause() : Tone.Transport.start(); }
        }
    };

    // =================================================================================
    // NAVIGATION MODULE
    // =================================================================================
    const Navigation = {
        screens: {},
        init() {
            this.screens = { 
                splash: document.getElementById('splash-screen'), 
                lobby: document.getElementById('main-lobby'), 
                gacha: document.getElementById('gacha-screen'), 
                heroMgmt: document.getElementById('hero-management-screen'), 
                heroSelect: document.getElementById('hero-selection-screen'), 
                truco: document.getElementById('truco-screen'), 
            };
            const setupListener = (id, screen, callback) => { const element = document.getElementById(id); if (element) { element.addEventListener('click', () => { SoundManager.playUIClick(); if (callback) callback(); this.show(screen); }); } };
            document.getElementById('btn-enter-lobby').addEventListener('click', () => { SoundManager.playUIClick(); this.show('lobby'); if (!localStorage.getItem('projetoRevsWelcomeTutorialSeen')) { UIManager.showTutorial('welcome'); localStorage.setItem('projetoRevsWelcomeTutorialSeen', 'true'); } });
            document.getElementById('sound-control').addEventListener('click', () => SoundManager.toggleMute());
            document.getElementById('btn-summon-hero').addEventListener('click', () => { SoundManager.playUIClick(); GameManager.summonHero(); });
            setupListener('gacha-back-to-lobby', 'lobby');
            setupListener('management-back-to-lobby', 'lobby');
            setupListener('selection-back-to-lobby', 'lobby');
            
            // ✨ MUDANÇA: O botão de sair do truco agora é gerenciado pelo TrucoGame para permitir a confirmação.
            // setupListener('truco-back-to-lobby', 'lobby'); 

            setupListener('lobby-back-to-splash', 'splash');
            
            document.getElementById('main-tutorial-btn').addEventListener('click', () => {
                SoundManager.playUIClick();
                UIManager.showTutorial('welcome');
            });

            document.getElementById('nav-truco').addEventListener('click', () => { 
                SoundManager.playUIClick(); 
                if (!localStorage.getItem('revsTutorialSeen')) {
                    UIManager.showTutorial('truco-briefing');
                    localStorage.setItem('revsTutorialSeen', 'true');
                } else {
                    UIManager.showModal('mode-selection-modal');
                }
            });

            document.getElementById('btn-select-revs').addEventListener('click', () => {
                SoundManager.playUIClick();
                UIManager.hideModal('mode-selection-modal');
                GameManager.initHeroSelection('revs');
                this.show('heroSelect');
            });
            
            // *** MODIFICADO: Mão de Ferro agora pula a seleção de heróis ***
            document.getElementById('btn-select-iron-hand').addEventListener('click', () => {
                SoundManager.playUIClick();
                const cost = CONSTANTS.IRON_HAND_COST;
                if (PlayerData.data.coins < cost) {
                    UIManager.showNotification(`Insufficient Coins. Cost: ${cost}`, 'danger');
                    return;
                }
                PlayerData.addCoins(-cost);
                UIManager.showNotification(`- ${cost} Coins. Good luck, rebel!`, 'coin');
                UIManager.hideModal('mode-selection-modal');
                // Pula a seleção de heróis e vai direto para o jogo
                TrucoGame.startMatch([], 'ironHand'); // Passa uma equipe vazia
                this.show('truco');
            });


            document.getElementById('nav-lore').addEventListener('click', () => { 
                SoundManager.playUIClick(); 
                UIManager.showTutorial('lore'); 
            });
            document.getElementById('nav-heroes-to-selection').addEventListener('click', () => { SoundManager.playUIClick(); UIManager.showModal('mode-selection-modal'); });
            document.getElementById('nav-heroes').addEventListener('click', () => { SoundManager.playUIClick(); this.show('heroMgmt'); GameManager.initHeroManagement(); });
            document.getElementById('nav-gacha').addEventListener('click', () => { SoundManager.playUIClick(); this.show('gacha'); });

            const btnConfirmTeam = document.getElementById('btn-confirm-team');
            if(btnConfirmTeam) btnConfirmTeam.addEventListener('click', () => { if (!btnConfirmTeam.disabled) { SoundManager.playUIClick(); TrucoGame.startMatch(GameManager.selectedTeam, GameManager.selectedGameMode); this.show('truco'); } });
            
            const btnBackToLobbyFromTruco = document.getElementById('btnBackToLobbyFromTruco');
            if(btnBackToLobbyFromTruco) btnBackToLobbyFromTruco.addEventListener('click', () => { SoundManager.playUIClick(); document.getElementById('modalEndHand').classList.remove('show'); this.show('lobby'); });
        },
        show(screenId) {
            SoundManager.playScreenTransition();
            Object.values(this.screens).forEach(screen => {
                if (screen && !screen.classList.contains('hidden')) {
                    screen.style.animation = 'screen-glitch-out 0.2s forwards';
                }
            });

            setTimeout(() => {
                for (const id in this.screens) {
                    if (this.screens[id]) {
                        this.screens[id].style.animation = ''; // Clear animation
                        this.screens[id].classList.toggle('hidden', id !== screenId);
                    }
                }
                if (screenId === 'lobby') { PlayerData.updateUI(); }
                const missionsToggle = document.getElementById('missions-toggle-btn');
                if (missionsToggle) { missionsToggle.style.display = (screenId === 'lobby') ? 'flex' : 'none'; }
                const missionsContainer = document.getElementById('missions-container');
                if (screenId !== 'lobby' && missionsContainer) { missionsContainer.classList.remove('show'); }
            }, 200);
        }
    };
    
    // =================================================================================
    // GAME MANAGEMENT MODULE
    // =================================================================================
    const GameManager = {
        // ✨ MODIFIED: Added 'upgrades' array to each hero
        allRebels: [
            // === PASSIVE REBELS ===
            { 
                id: 'jolt', name: 'Jolt', rarity: 'Rare', faction: 'Wild', type: 'passive',
                lore: 'A brute whose fury grows with victory, energizing the cell.',
                ability: { 
                    name: "Battle Frenzy",
                    base: "Whenever you win a round with a higher value card (non-strongest), gain +1 additional Charge." 
                },
                upgrades: [
                    "Level 1: Gain +1 additional Charge when winning a trick with a non-strongest, higher-value card.",
                    "Level 2: The bonus Charge is now +2.",
                    "Level 3: Also gain +1 Charge when tying a trick.",
                ],
                img: 'https://i.imgur.com/UNeqTym.png' 
            },
            { 
                id: 'echo', name: 'Echo', rarity: 'Rare', faction: 'Arcane', type: 'passive',
                lore: 'A hacker who reads the future in data streams, predicting threats.',
                ability: {
                    name: "Continuous Scan",
                    base: "At the start of each round, reveals if the opponent still has any strongest cards in their hand." 
                },
                upgrades: [
                    "Level 1: Reveals the presence of a strongest card in the opponent's hand.",
                    "Level 2: Now also reveals the SUIT of one of the opponent's cards at random.",
                    "Level 3: Reveals the presence and COUNT of strongest cards in the opponent's hand."
                ],
                img: 'https://i.imgur.com/vypppw7.png' 
            },
            
            // === HYBRID REBELS ===
            { 
                id: 'gaia', name: 'Gaia', rarity: 'Legendary', faction: 'Wild', type: 'hybrid',
                lore: 'A silent guardian who channels the raw power of the urban jungle.',
                ability: {
                    name: "Terrain Bond",
                    base: "P: If the Trump Card is ♦ or ♣, your weakest card gains +2 strength. A: (5 Charge) Force the opponent to play their strongest card (they gain 2 Charge).",
                    passive_desc: "If the Trump Card is Diamonds (♦) or Clubs (♣), your lowest value card in hand gets +2 strength.",
                    active_desc: "(Cost 5 Charge): Force the opponent to play their highest value card this round. They receive +2 Charge at the end of the round."
                },
                upgrades: [
                    "Level 1: P: +2 strength to weakest card if trump is ♦/♣. A(5): Force strongest card play.",
                    "Level 2: P: The strength bonus is now +3. A: Cost reduced to 4 Charge.",
                    "Level 3: P: The passive now works with ANY suit. A: Opponent no longer receives bonus charge."
                ],
                img: 'https://i.imgur.com/tMmagZM.png' 
            },
            { 
                id: 'phantom', name: 'Phantom', rarity: 'Legendary', faction: 'Shadow', type: 'hybrid',
                lore: 'Master of illusions, he turns the enemy\'s certainty into chaos.',
                ability: {
                    name: "Ghost Disruption",
                    base: "P: Hides the value of the enemy's 'Revolution' call. A: (5 Charge) In response to a 'Revolution', cancel the bet and swap a random card with the opponent.",
                    passive_desc: "Shadow Cloak: Hides the value of the opponent's 'Revolution' call (shows '???').",
                    active_desc: "(Cost 5 Charge): In response to a 'Revolution' call, cancel the bet and swap a random card with the opponent."
                },
                upgrades: [
                    "Level 1: P: Hide opponent's bet value. A(5): Cancel bet and swap cards.",
                    "Level 2: A: Now you swap YOUR weakest card for their random card.",
                    "Level 3: P: Now also hides the opponent's final trick score until the hand ends. A: Cost reduced to 4 Charge."
                ],
                img: 'https://i.imgur.com/84wW0nM.png' 
            },

            // === ACTIVE REBELS ===
            { 
                id: 'dory', name: 'Dory', rarity: 'Epic', faction: 'Arcane', type: 'active',
                lore: 'A seer who manipulates luck, turning chaos into advantage.',
                ability: { 
                    name: "Distort Fate",
                    base: "(Cost 4 Charge): Look at the top 3 cards of the deck and choose one to be the new Trump Card." 
                },
                upgrades: [
                    "Level 1: (Cost 4) Choose 1 of 3 cards from the deck as the new Trump.",
                    "Level 2: Cost reduced to 3 Charge.",
                    "Level 3: You now see the top 4 cards of the deck to choose from."
                ],
                img: 'https://i.imgur.com/BTewoLg.png' 
            },
            { 
                id: 'silo', name: 'Silo', rarity: 'Common', faction: 'Shadow', type: 'active',
                lore: 'A thief who never plays with the cards he was dealt.',
                ability: { 
                    name: "Sleight of Hand",
                    base: "(Cost 3 Charge): Draw a card from the deck, then discard one of the four cards in your hand." 
                },
                upgrades: [
                    "Level 1: (Cost 3) Draw 1, discard 1.",
                    "Level 2: Cost reduced to 2 Charge.",
                    "Level 3: You now draw 2 cards and discard 2 from the five in your hand."
                ],
                img: 'https://i.imgur.com/LyRmiE0.png' 
            }
        ],
        selectedTeam: { passive: null, hybrid: null, active: null },
        selectedGameMode: 'revs',
        // ✨ NEW: State for filters
        currentFilter: 'all',
        currentSort: 'name',
        init() { this.updateFeaturedHero(); this.setupFilterListeners(); },
        updateFeaturedHero() { const featured = this.allRebels.find(h => h.rarity === 'Epic'); const banner = document.getElementById('featured-hero-banner'); banner.innerHTML = `<img src="${featured.img}" class="w-20 h-20 rounded-full border-2" style="border-color: var(--rarity-epic);" alt="${featured.name}"><div class="text-left"><p class="text-sm" style="color: var(--rarity-epic);">Featured Rebel</p><h3 class="text-2xl font-bold font-['Orbitron']" style="color: var(--text-light);">${featured.name}</h3><p class="text-sm text-slate-400">${featured.ability.base}</p></div>`; },
        // ✨ NEW: Setup for filter and sort buttons
        setupFilterListeners() {
            document.querySelectorAll('#faction-filters button').forEach(button => {
                button.addEventListener('click', (e) => {
                    this.currentFilter = e.target.dataset.filter;
                    document.querySelector('#faction-filters .active').classList.remove('active');
                    e.target.classList.add('active');
                    this.initHeroManagement();
                });
            });
            document.getElementById('hero-sort').addEventListener('change', (e) => {
                this.currentSort = e.target.value;
                this.initHeroManagement();
            });
        },
        summonHero() {
            const cost = CONSTANTS.GACHA_COST;
            if (PlayerData.data.gems < cost) {
                UIManager.showNotification("Insufficient Chips!", 'danger');
                return;
            }
            SoundManager.playSummonStart();
            PlayerData.addGems(-cost);
            const btn = document.getElementById('btn-summon-hero');
            btn.disabled = true;

            document.getElementById('gacha-placeholder').style.display = 'none';
            document.getElementById('gacha-card').classList.add('hidden'); 

            const shuffler = document.getElementById('gacha-card-shuffler');
            shuffler.innerHTML = '';
            shuffler.classList.add('active');

            const numCards = 5;
            for (let i = 0; i < numCards; i++) {
                const cardEl = document.createElement('div');
                cardEl.className = 'shuffle-card';
                cardEl.style.setProperty('--i', i);
                shuffler.appendChild(cardEl);
            }

            setTimeout(() => {
                const rand = Math.random();
                let chosenHero;
                if (rand < 0.05) { const legends = this.allRebels.filter(h => h.rarity === 'Legendary'); chosenHero = legends[Math.floor(Math.random() * legends.length)]; }
                else if (rand < 0.25) { const epics = this.allRebels.filter(h => h.rarity === 'Epic'); chosenHero = epics[Math.floor(Math.random() * epics.length)]; }
                else if (rand < 0.60) { const rares = this.allRebels.filter(h => h.rarity === 'Rare'); chosenHero = rares[Math.floor(Math.random() * rares.length)]; }
                else { const commons = this.allRebels.filter(h => h.rarity === 'Common'); chosenHero = commons[Math.floor(Math.random() * commons.length)]; }

                shuffler.classList.remove('active');
                shuffler.innerHTML = '';

                SoundManager.playSummonReveal(chosenHero.rarity);
                PlayerData.addHero(chosenHero.id);

                const card = document.getElementById('gacha-card');
                card.style.borderColor = `var(--rarity-${chosenHero.rarity.toLowerCase()})`;
                document.getElementById('gacha-hero-img').src = chosenHero.img;
                const rarityEl = document.getElementById('gacha-rarity');
                rarityEl.textContent = chosenHero.rarity;
                rarityEl.style.color = `var(--rarity-${chosenHero.rarity.toLowerCase()})`;
                document.getElementById('gacha-hero-name').textContent = chosenHero.name;
                document.getElementById('gacha-hero-ability').textContent = chosenHero.ability.base;

                card.classList.remove('hidden');
                card.style.animation = 'none';
                card.offsetHeight; /* trigger reflow */
                card.style.animation = `card-reveal 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards`;

                btn.disabled = false;
            }, 2500);
        },
        // ✨ REWRITTEN: Hero Management now uses filters, sorting, and displays more info
        initHeroManagement() {
            const grid = document.getElementById('management-hero-grid');
            grid.innerHTML = '';

            const rarityOrder = { 'Legendary': 4, 'Epic': 3, 'Rare': 2, 'Common': 1 };

            const ownedRebels = this.allRebels
                .filter(hero => PlayerData.data.rebels[hero.id]) // Player must own the hero
                .filter(hero => this.currentFilter === 'all' || hero.faction === this.currentFilter) // Apply faction filter
                .sort((a, b) => { // Apply sorting
                    switch (this.currentSort) {
                        case 'rarity':
                            return rarityOrder[b.rarity] - rarityOrder[a.rarity];
                        case 'level':
                            return PlayerData.data.rebels[b.id].level - PlayerData.data.rebels[a.id].level;
                        case 'name':
                        default:
                            return a.name.localeCompare(b.name);
                    }
                });

            ownedRebels.forEach(hero => {
                const heroData = PlayerData.data.rebels[hero.id];
                const card = document.createElement('div');
                // ✨ ADDED: Rarity class for border color
                card.className = `hero-card rarity-${hero.rarity.toLowerCase()}`;

                const cost = heroData.level * CONSTANTS.EVOLVE_BASE_COST * heroData.level;
                const dupNeeded = heroData.level;
                const canEvolve = PlayerData.data.coins >= cost && heroData.duplicates >= dupNeeded;
                const progress = (heroData.duplicates / dupNeeded) * 100;

                card.innerHTML = `
                    <div class="faction-badge faction-${hero.faction}">${hero.faction}</div>
                    <img src="${hero.img}" alt="${hero.name}">
                    <h3 class="hero-name">${hero.name}</h3>
                    <div class="flex items-center justify-center gap-2 text-xs text-slate-400 mb-2">
                        <span>${hero.ability.base}</span>
                        <i class="bx bxs-info-circle text-lg cursor-pointer hover:text-white" data-hero-id="${hero.id}"></i>
                    </div>
                    <p class="hero-level-info">Level: ${heroData.level}</p>
                    <div class="hero-duplicates-bar"><div class="hero-duplicates-fill" style="width: ${progress}%"></div></div>
                    <p class="hero-duplicates">Copies: ${heroData.duplicates} / ${dupNeeded}</p>
                    <div class="flex justify-center mt-2 gap-2">
                        <button class="btn-primary flex-grow" data-hero-id="${hero.id}" ${canEvolve ? '' : 'disabled'}>Upgrade (${cost})</button>
                    </div>`;

                card.querySelector('.btn-primary').onclick = (e) => { e.stopPropagation(); SoundManager.playUIClick(); this.evolveHero(e.target.dataset.heroId); };
                // ✨ NEW: Click listener for info icon
                card.querySelector('.bxs-info-circle').onclick = (e) => { e.stopPropagation(); SoundManager.playUIClick(); UIManager.showHeroDetails(hero); };
                grid.appendChild(card);
            });
        },
        // ✨ MODIFIED: Now applies animation on evolution
        evolveHero(heroId) {
            const heroData = PlayerData.data.rebels[heroId];
            const cost = heroData.level * CONSTANTS.EVOLVE_BASE_COST * heroData.level;
            const dupNeeded = heroData.level;
            if (PlayerData.data.coins >= cost && heroData.duplicates >= dupNeeded) {
                PlayerData.addCoins(-cost);
                heroData.duplicates -= dupNeeded;
                heroData.level++;
                PlayerData.save();
                SoundManager.playLevelUp();

                // Find the specific card on screen to animate it
                const cardToAnimate = document.querySelector(`.hero-card .btn-primary[data-hero-id="${heroId}"]`).closest('.hero-card');
                if (cardToAnimate) {
                    cardToAnimate.classList.add('evolving');
                    // Wait for animation to finish before re-rendering
                    setTimeout(() => {
                        this.initHeroManagement();
                    }, 800); // Must match animation duration
                } else {
                    this.initHeroManagement(); // Fallback if card isn't found
                }
            }
        },
        
        initHeroSelection(gameMode) {
            this.selectedGameMode = gameMode;
            this.selectedTeam = { passive: null, hybrid: null, active: null };
            
            const hybridCol = document.getElementById('hybrid-selection');
            const activeCol = document.getElementById('active-selection');
            const passiveCol = document.getElementById('passive-selection');
            
            passiveCol.innerHTML = '<h3>Passive Core</h3>';
            hybridCol.innerHTML = '<h3>Hybrid Style</h3>';
            activeCol.innerHTML = '<h3>Active Trump</h3>';

            const isIronHand = gameMode === 'ironHand';
            hybridCol.style.display = isIronHand ? 'none' : 'flex';
            activeCol.style.display = isIronHand ? 'none' : 'flex';
            
            document.querySelector('#hero-selection-grid-container').style.gridTemplateColumns = isIronHand ? '1fr' : 'repeat(3, 1fr)';
            passiveCol.style.gridColumn = isIronHand ? '1 / -1' : 'auto';

            this.allRebels.forEach(hero => {
                if (!PlayerData.data.rebels[hero.id]) return;
                
                const card = this.createHeroCard(hero);
                card.addEventListener('click', () => this.selectHero(hero, card));

                if (hero.type === 'passive') passiveCol.appendChild(card);
                else if (hero.type === 'hybrid') hybridCol.appendChild(card);
                else if (hero.type === 'active') activeCol.appendChild(card);
            });
            this.updateTeamDisplay();
        },

        createHeroCard(hero) {
            const card = document.createElement('div');
            card.className = 'hero-card';
            card.dataset.heroId = hero.id;
            card.dataset.heroType = hero.type;
            
            let abilityHtml;
            if (hero.type === 'hybrid') {
                abilityHtml = `
                    <p class="text-xs text-slate-400 font-bold text-cyan-400">PASSIVE:</p>
                    <p class="text-xs text-slate-400 mb-1">${hero.ability.passive_desc}</p>
                    <p class="text-xs text-slate-400 font-bold text-fuchsia-400">ACTIVE:</p>
                    <p class="text-xs text-slate-400">${hero.ability.active_desc}</p>`;
            } else {
                abilityHtml = `<p class="text-sm text-slate-400">${hero.ability.base}</p>`;
            }

            card.innerHTML = `
                <div class="faction-badge faction-${hero.faction}">${hero.faction}</div>
                <div class="hero-tooltip">${hero.lore}</div>
                <img src="${hero.img}" alt="${hero.name}">
                <h3 class="hero-name">${hero.name}</h3>
                ${abilityHtml}`;
            return card;
        },

        selectHero(hero, cardElement) {
            SoundManager.playUIClick();
            
            cardElement.classList.add('selected-animation-effect');
            setTimeout(() => {
                cardElement.classList.remove('selected-animation-effect');
            }, 400);

            if (this.selectedTeam[hero.type] && this.selectedTeam[hero.type].id === hero.id) {
                this.selectedTeam[hero.type] = null;
            } else {
                this.selectedTeam[hero.type] = hero;
            }
            this.updateTeamDisplay();
        },

        updateTeamDisplay() {
            document.querySelectorAll('.hero-selection-column .hero-card').forEach(card => {
                const type = card.dataset.heroType;
                const id = card.dataset.heroId;
                card.classList.toggle('selected', this.selectedTeam[type] && this.selectedTeam[type].id === id);
            });

            const isIronHand = this.selectedGameMode === 'ironHand';
            document.querySelector('.hero-team-slot[data-slot="hybrid"]').style.display = isIronHand ? 'none' : 'flex';
            document.querySelector('.hero-team-slot[data-slot="active"]').style.display = isIronHand ? 'none' : 'flex';


            for (const type in this.selectedTeam) {
                const slot = document.querySelector(`.hero-team-slot[data-slot="${type}"]`);
                const hero = this.selectedTeam[type];
                if (hero) {
                    slot.innerHTML = `<img src="${hero.img}" alt="${hero.name}"><p class="text-xs font-bold">${hero.name}</p>`;
                } else {
                    slot.innerHTML = `?`;
                }
            }

            const isComplete = isIronHand 
                ? this.selectedTeam.passive != null
                : this.selectedTeam.passive && this.selectedTeam.hybrid && this.selectedTeam.active;
            document.getElementById('btn-confirm-team').disabled = !isComplete;
        },
    };

    // =================================================================================
    // MISSIONS MODULE
    // =================================================================================
    const MissionsManager = {
        // ✨ MUDANÇA: Novas missões adicionadas para incentivar a conclusão e o jogo
        missions: [
            { id: 'win_hands', desc: 'Win 3 hands in Revs', goal: 3, reward: { coins: 100 } },
            { id: 'complete_matches', desc: 'Complete 3 matches of Revs', goal: 3, reward: { xp: 75 } },
            { id: 'win_tricks', desc: 'Win 10 rounds (\'tricks\')', goal: 10, reward: { coins: 50 } },
            { id: 'play_manilha', desc: 'Play 1 Strongest Card', goal: 1, reward: { gems: 5 } },
            { id: 'ask_truco', desc: 'Call Revolution 2 times', goal: 2, reward: { xp: 50 } },
        ],
        init() { document.getElementById('missions-list').addEventListener('click', (e) => { if (e.target.classList.contains('btn-claim-reward')) { SoundManager.playUIClick(); this.claimReward(e.target.dataset.missionId); } }); this.updateUI(); },
        updateUI() {
            const container = document.getElementById('missions-list');
            if (!container) return;
            container.innerHTML = '';
            this.missions.forEach(mission => {
                const progress = PlayerData.data.missions.progress[mission.id] || 0;
                const isComplete = progress >= mission.goal;
                const isClaimed = PlayerData.data.missions.progress[`claimed_${mission.id}`];
                const progressPercent = Math.min((progress / mission.goal) * 100, 100);
                let rewardText = '';
                if(mission.reward.coins) rewardText = `${mission.reward.coins} Coins`;
                if(mission.reward.gems) rewardText = `${mission.reward.gems} Chips`;
                if(mission.reward.xp) rewardText = `${mission.reward.xp} XP`;
                const missionEl = document.createElement('div');
                missionEl.className = `mission ${isComplete && !isClaimed ? 'completed' : ''} p-2 border-b border-gray-700`;
                missionEl.innerHTML = `<div class="text-sm">${mission.desc} (${progress}/${mission.goal})</div> <div class="w-full bg-gray-900 rounded-full h-2.5 my-1"><div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div></div> <button class="btn-success btn-claim-reward w-full text-xs py-1 mt-1" data-mission-id="${mission.id}" ${!isComplete || isClaimed ? 'disabled' : ''}> ${isClaimed ? 'Collected' : `Collect (+${rewardText})`} </button>`;
                container.appendChild(missionEl);
            });
        },
        claimReward(missionId) { const mission = this.missions.find(m => m.id === missionId); PlayerData.data.missions.progress[`claimed_${missionId}`] = true; if(mission.reward.coins) PlayerData.addCoins(mission.reward.coins); if(mission.reward.gems) PlayerData.addGems(mission.reward.gems); if(mission.reward.xp) PlayerData.addXP(mission.reward.xp); SoundManager.playRewardClaim(); this.updateUI(); }
    };
    
    // =================================================================================
    // TRUCO GAME MODULE
    // =================================================================================
    const TrucoGame = {
        state: {}, 
        el: {}, 
        stakeLadder: ["REVOLUTION", "INSURRECTION", "COUP", "VICTORY"], 
        stakePoints: [1, 3, 6, 9, 12],
        init() {
            this.el = { 
                handYou: document.querySelector('#handYou'), 
                handAI: document.querySelector('#handAI'), 
                slotYou: document.querySelector('#slotYou'), 
                slotAI: document.querySelector('#slotAI'), 
                status: document.querySelector('#status'), 
                ptsYou: document.querySelector('#ptsYou'), 
                ptsAI: document.querySelector('#ptsAI'), 
                stake: document.querySelector('#handStake'), 
                btnTruco: document.querySelector('#btnTruco'), 
                btnRun: document.querySelector('#btnRun'), 
                btnAccept: document.querySelector('#btnAccept'), 
                viraSlot: document.querySelector('#vira-card-slot'), 
                modalEndGame: document.querySelector('#modalEndGame'), 
                endGameTitle: document.querySelector('#endGameTitle'), 
                endGameText: document.querySelector('#endGameText'), 
                btnNewMatch: document.querySelector('#btnNewMatch'), 
                modalEndHand: document.querySelector('#modalEndHand'), 
                endHandTitle: document.querySelector('#endHandTitle'), 
                endHandText: document.querySelector('#endHandText'), 
                btnNextHand: document.querySelector('#btnNextHand'), 
                heroInfoSidebar: document.getElementById('truco-hero-info'), 
                sidebar: document.getElementById('truco-sidebar'), 
                banterBox: document.getElementById('truco-banter-box'), 
                btnConfirmPlay: document.getElementById('btnConfirmPlay'), 
                btnCancelPlay: document.getElementById('btnCancelPlay'), 
                trucoOverlay: document.getElementById('truco-text-overlay'), 
                screen: document.getElementById('truco-screen'),
                trickMarkersYou: document.getElementById('trick-markers-you'),
                trickMarkersAI: document.getElementById('trick-markers-ai'),
                trucoTable: document.querySelector('.truco-table'),
                playerCharge: document.getElementById('player-charge'),
                doryModal: document.getElementById('dory-choice-modal'),
                doryCardChoices: document.getElementById('dory-card-choices'),
            };
            this.el.btnNewMatch.addEventListener('click', () => { SoundManager.playUIClick(); this.el.modalEndGame.classList.remove('show'); this.newMatch(); });
            this.el.btnTruco.addEventListener('click', () => { SoundManager.playUIClick(); this.handleTrucoCall(); });
            this.el.btnRun.addEventListener('click', () => { SoundManager.playUIClick(); this.clearDecisionTimer(); this.respondToTruco('you', 'run'); });
            this.el.btnAccept.addEventListener('click', () => { SoundManager.playUIClick(); this.clearDecisionTimer(); this.respondToTruco('you', 'accept'); });
            this.el.btnNextHand.addEventListener('click', () => { SoundManager.playUIClick(); this.el.modalEndHand.classList.remove('show'); this.newHand(); });

            // ✨ MUDANÇA: Lógica do botão de sair com confirmação
            const btnLeave = document.getElementById('truco-back-to-lobby');
            const btnConfirmLeave = document.getElementById('btn-confirm-action');
            const btnCancelLeave = document.getElementById('btn-cancel-action');

            btnLeave.addEventListener('click', () => {
                SoundManager.playUIClick();
                // Não mostra o modal se a partida já terminou
                if (this.state.ptsYou >= 12 || this.state.ptsAI >= 12 || this.state.gameMode === 'ironHand' && (this.state.ironHandYouWins >= 2 || this.state.ironHandAIWins >= 2)) {
                    Navigation.show('lobby');
                    return;
                }
                UIManager.showModal('confirm-modal');
            });

            btnConfirmLeave.addEventListener('click', () => {
                SoundManager.playUIClick();
                UIManager.hideModal('confirm-modal');
                Navigation.show('lobby');
            });

            btnCancelLeave.addEventListener('click', () => {
                SoundManager.playUIClick();
                UIManager.hideModal('confirm-modal');
            });
        },
        handleTrucoCall() {
            const canPlayerCall = this.state.leader === 'you' && this.state.lastRaiser !== 'you';
            const canPlayerRaise = this.state.asking === 'you';

            if (canPlayerRaise) {
                this.clearDecisionTimer();
                this.respondToTruco('you', 'raise');
            } else if (canPlayerCall) {
                this.askTruco('you');
            }
        },
        
        // *** MODIFICADO: Lógica central para iniciar a partida, agora diferencia os modos de jogo ***
        startMatch(team, gameMode) {
            this.state.gameMode = gameMode;
            this.el.screen.classList.toggle('iron-hand-mode', gameMode === 'ironHand');

            // Limpa containers de UI
            this.el.heroInfoSidebar.innerHTML = '';
            const mobileAbilitiesContainer = document.getElementById('mobile-hero-abilities');
            if(mobileAbilitiesContainer) mobileAbilitiesContainer.innerHTML = '';
            
            // Lógica de HUD e Rebeldes
            if (this.state.gameMode === 'ironHand') {
                document.getElementById('score-label-you').textContent = 'Hands Won:';
                document.getElementById('score-label-ai').textContent = 'Hands Won:';
                document.getElementById('trick-container-you').style.display = 'none';
                document.getElementById('trick-container-ai').style.display = 'none';
                this.state.playerTeam = [];
                this.state.aiTeam = [];
            } else {
                 document.getElementById('score-label-you').textContent = 'Points:';
                document.getElementById('score-label-ai').textContent = 'Points:';
                document.getElementById('trick-container-you').style.display = 'flex';
                document.getElementById('trick-container-ai').style.display = 'flex';
                
                this.state.playerTeam = Object.values(team).filter(Boolean);

                const allRebels = GameManager.allRebels;
                const passiveRebels = allRebels.filter(r => r.type === 'passive');
                const hybridRebels = allRebels.filter(r => r.type === 'hybrid');
                const activeRebels = allRebels.filter(r => r.type === 'active');
                
                this.state.aiTeam = [
                    passiveRebels[Math.floor(Math.random() * passiveRebels.length)],
                    hybridRebels[Math.floor(Math.random() * hybridRebels.length)],
                    activeRebels[Math.floor(Math.random() * activeRebels.length)]
                ];
                console.log("Célula da Corporação:", this.state.aiTeam.map(r => r.name));

                // Monta a UI dos Rebeldes
                this.state.playerTeam.forEach(hero => {
                    let abilityHtml;
                    if (hero.type === 'hybrid') {
                        abilityHtml = `<p class="text-xs text-slate-300"><b class="text-cyan-400">P:</b> ${hero.ability.passive_desc}<br><b class="text-fuchsia-400">A:</b> ${hero.ability.active_desc}</p>`;
                    } else {
                        abilityHtml = `<p class="text-xs text-slate-300">${hero.ability.base}</p>`;
                    }
                    let heroCardHTML = `
                    <div id="sidebar-hero-${hero.id}" class="sidebar-hero-card bg-black bg-opacity-40 p-3 rounded-lg border border-cyan-500/20">
                        <div class="flex items-center gap-3">
                            <img src="${hero.img}" class="w-12 h-12 rounded-full border-2 border-cyan-400 object-cover">
                            <div class="text-left flex-grow">
                                <h3 class="font-bold text-md text-cyan-400 font-['Orbitron']">${hero.name}</h3>
                                ${abilityHtml}
                            </div>
                        </div>`;
                    if (hero.type !== 'passive') {
                        heroCardHTML += `<button id="ability-btn-${hero.id}" data-hero-id="${hero.id}" class="btn-special w-full mt-2 text-sm py-1">Activate</button>`;
                    }
                    heroCardHTML += `</div>`;
                    this.el.heroInfoSidebar.innerHTML += heroCardHTML;

                    if (hero.type !== 'passive' && mobileAbilitiesContainer) {
                        const mobileBtn = document.createElement('button');
                        mobileBtn.id = `mobile-ability-btn-${hero.id}`;
                        mobileBtn.dataset.heroId = hero.id;
                        mobileBtn.className = 'ability-button-mobile';
                        mobileBtn.style.backgroundImage = `url(${hero.img})`;
                        mobileBtn.title = `${hero.name}: ${hero.ability.name}`;
                        mobileAbilitiesContainer.appendChild(mobileBtn);
                    }
                });

                // Adiciona listeners dos botões de habilidade
                this.state.playerTeam.forEach(hero => {
                    if (hero.type !== 'passive') {
                        const btn = document.getElementById(`ability-btn-${hero.id}`);
                        if(btn) btn.addEventListener('click', (e) => this.activateAbility(e.target.dataset.heroId));

                        const mobileBtn = document.getElementById(`mobile-ability-btn-${hero.id}`);
                        if(mobileBtn) mobileBtn.addEventListener('click', (e) => this.activateAbility(e.target.dataset.heroId));
                    }
                });
            }

            this.newMatch();
        },
        newMatch() { 
            this.state = { 
                ...this.state, 
                ptsYou: 0, 
                ptsAI: 0, 
                youCarga: 0,
                aiCarga: 0,
                leader: Math.random() < .5 ? 'you' : 'ai', 
                handCount: 0,
                abilityCooldowns: {},
                ironHandYouWins: 0, // NEW
                ironHandAIWins: 0   // NEW
            }; 
            this.newHand(); 
        },
        newHand() {
            // ✨ CÓDIGO ATUALIZADO ✨: Reseta o efeito do cenário
            this.el.screen.classList.remove('scenario-broken');

            this.state.handCount++;
            const suits = ["♦", "♠", "♥", "♣"], ranks = ["4", "5", "6", "7", "Q", "J", "K", "A", "2", "3"];
            const deck = []; for (const s of suits) { for (const r of ranks) { deck.push({ r, s }); } }
            for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [deck[i], deck[j]] = [deck[j], deck[i]]; }
            
            this.state = { 
                ...this.state, 
                deck, 
                you: deck.splice(0, 3), 
                ai: deck.splice(0, 3), 
                table: { you: null, ai: null }, 
                trick: 1, 
                youTricks: 0, 
                aiTricks: 0, 
                asking: null, 
                stakeIdx: 0, 
                selectedCard: null, 
                revealedCard: null, 
                lastRaiser: null, 
                lastPlayedCard: null,
                isChoosingVira: false,
                isDiscarding: false,
                forcePlay: null,
                gaiaAbilityJustUsed: false
            };
            this.state.vira = this.state.deck.shift();
            const rankOrder = ["4", "5", "6", "7", "Q", "J", "K", "A", "2", "3"];
            this.state.manilhaRank = rankOrder[(rankOrder.indexOf(this.state.vira.r) + 1) % rankOrder.length];
            
            if (this.state.gameMode !== 'ironHand') {
                this.getBanter('start');
            }
            this.render();
            
            const playerHandCards = this.el.handYou.querySelectorAll('.card');
            playerHandCards.forEach((card, index) => {
                card.style.animationDelay = `${index * 100}ms`;
                card.classList.add('card-materializing');
            });

            this.applyPassiveAbilities();
            this.startOfTrickEffects();
            
            if (this.state.leader === 'ai') setTimeout(() => this.aiPlay(), 500);
        },
        render() {
            this.el.playerCharge.textContent = this.state.youCarga;
            this.el.handYou.innerHTML = ''; this.state.you.forEach(c => this.el.handYou.appendChild(this.cardView(c, true)));
            this.el.handAI.innerHTML = ''; 
            this.state.ai.forEach(c => { if (this.state.revealedCard === c) { this.el.handAI.appendChild(this.cardView(c, false)); } else { const cardBack = document.createElement('div'); cardBack.className = 'card back'; this.el.handAI.appendChild(cardBack); } });
            this.renderSlot(this.el.slotYou, this.state.table.you); this.renderSlot(this.el.slotAI, this.state.table.ai);
            this.el.viraSlot.innerHTML = ''; this.el.viraSlot.appendChild(this.cardView(this.state.vira, false));
            
            if (this.state.gameMode === 'ironHand') {
                this.el.ptsYou.textContent = this.state.ironHandYouWins;
                this.el.ptsAI.textContent = this.state.ironHandAIWins;
            } else {
                this.el.ptsYou.textContent = this.state.ptsYou;
                this.el.ptsAI.textContent = this.state.ptsAI;
            }

            Array.from(this.el.trickMarkersYou.children).forEach(m => m.classList.remove('won'));
            Array.from(this.el.trickMarkersAI.children).forEach(m => m.classList.remove('won'));
            for(let i = 0; i < this.state.youTricks; i++) { if(this.el.trickMarkersYou.children[i]) this.el.trickMarkersYou.children[i].classList.add('won'); }
            for(let i = 0; i < this.state.aiTricks; i++) { if(this.el.trickMarkersAI.children[i]) this.el.trickMarkersAI.children[i].classList.add('won'); }
            
            const stake = this.getStake();
            this.el.stake.textContent = `${stake}`;
            
            let statusText = this.state.leader === 'you' ? 'Your turn.' : "Corp's turn.";
            if(this.state.asking) statusText = this.state.asking === 'ai' ? "Corp is deciding..." : 'You have been challenged!';
            if(this.state.isChoosingVira) statusText = 'Choose a new Trump Card...';
            if(this.state.isDiscarding) statusText = 'Choose a card to discard.';
            this.el.status.textContent = statusText;
            
            const isPlayerTurn = this.state.leader === 'you' && !this.state.asking && !this.state.isChoosingVira && !this.state.isDiscarding;
            const isResponding = this.state.asking === 'you';
            const canRaise = this.state.stakeIdx < this.stakeLadder.length - 1;

            this.el.btnRun.classList.toggle('hidden', !isResponding);
            this.el.btnAccept.classList.toggle('hidden', !isResponding);

            const canPlayerCall = (isPlayerTurn && this.state.lastRaiser !== 'you') || isResponding;
            this.el.btnTruco.classList.toggle('hidden', !canPlayerCall || !canRaise || this.state.isChoosingVira || this.state.isDiscarding);
            
            if (!this.el.btnTruco.classList.contains('hidden')) {
                const nextStakeIndex = isResponding ? this.state.stakeIdx + 1 : (this.state.stakeIdx === 0 ? 1 : this.state.stakeIdx + 1);
                if (this.stakeLadder[nextStakeIndex - 1]) {
                    this.el.btnTruco.textContent = this.stakeLadder[nextStakeIndex - 1];
                }
            }
            
            if(this.state.playerTeam){
                this.state.playerTeam.forEach(hero => { 
                    if(!hero || hero.type === 'passive' || this.state.gameMode === 'ironHand') return;
                    
                    const sidebarBtn = document.getElementById(`ability-btn-${hero.id}`);
                    const mobileBtn = document.getElementById(`mobile-ability-btn-${hero.id}`);
                    const heroCard = document.getElementById(`sidebar-hero-${hero.id}`);
                    if (!heroCard && !mobileBtn) return;

                    const cargaReq = parseInt(hero.ability.active_desc?.match(/Cost (\d+) Charge/)?.[1] || hero.ability.base.match(/Cost (\d+) Charge/)?.[1] || 99);
                    
                    let isEnabled = this.state.youCarga >= cargaReq;

                    if (hero.id === 'phantom') {
                        isEnabled = isEnabled && isResponding;
                    } else {
                        isEnabled = isEnabled && isPlayerTurn;
                    }

                    if (sidebarBtn) sidebarBtn.disabled = !isEnabled;
                    if (mobileBtn) mobileBtn.disabled = !isEnabled;
                    
                    if (heroCard) heroCard.classList.toggle('ability-ready-glow', isEnabled);
                    if (mobileBtn) mobileBtn.classList.toggle('ability-ready-glow', isEnabled);
                    
                    if (sidebarBtn) sidebarBtn.textContent = `Activate (${cargaReq} Charge)`;
                });
            }
        },
        cardView(c, playable) {
            const d = document.createElement('div');
            d.setAttribute('data-suit', c.s);
            
            if (this.state.isDiscarding && playable) {
                d.className = `card ${['♥','♦'].includes(c.s) ? 'red' : 'black'} playable`;
                if (this.isManilha(c)) d.classList.add('manilha-glow');
                d.innerHTML = `<span class="rank">${c.r}</span><span class="suit">${c.s}</span>`;
                d.onclick = () => this.selectCard(c);
                return d;
            }

            if (this.state.gameMode === 'ironHand' && playable) {
                d.className = `card back playable`;
                if (this.state.selectedCard === c) d.classList.add('selected-to-play');
                d.onclick = () => this.selectCard(c);
                return d;
            }

            let cardClasses = `card ${['♥','♦'].includes(c.s) ? 'red' : 'black'}`;
            if (this.isManilha(c)) cardClasses += ' manilha-glow';
            if (this.state.selectedCard === c) cardClasses += ' selected-to-play';
            if (playable && this.state.leader === 'you' && !this.state.asking && !this.state.isDiscarding) cardClasses += ' playable';
            d.className = cardClasses;
            d.innerHTML = `<span class="rank">${c.r}</span><span class="suit">${c.s}</span>`;
            if (playable && (this.state.leader === 'you' && !this.state.asking && !this.state.isDiscarding)) { d.onclick = () => this.selectCard(c); }
            return d;
        },
        renderSlot(slot, c) {
            slot.innerHTML = '';
            if (c) {
                const cardView = this.cardView(c, false);
                if (c === this.state.lastPlayedCard) {
                    cardView.classList.add('card-played-animation');
                    this.state.lastPlayedCard = null;
                }
                slot.appendChild(cardView);
            }
        },
        selectCard(c) {
            SoundManager.playUIClick();
            if (this.state.isDiscarding) { this.executeDiscard(c); return; }
            if (this.state.leader !== 'you' || !this.state.you.includes(c) || this.state.asking) return;
            
            this.state.selectedCard = c;
            this.render();

            setTimeout(() => {
                if (this.isManilha(c)) {
                    SoundManager.playManilhaSlam();
                    this.el.screen.classList.add('shake-effect');
                    setTimeout(() => this.el.screen.classList.remove('shake-effect'), 300);
                    if (this.state.gameMode !== 'ironHand') this.getBanter('manilha');
                    PlayerData.trackMission('play_manilha');
                } else {
                    SoundManager.playCardSlam();
                }
                this.state.table.you = c;
                this.state.lastPlayedCard = c;
                this.state.you.splice(this.state.you.indexOf(c), 1);
                this.state.selectedCard = null;
                this.state.leader = 'ai';

                this.el.slotYou.classList.add('slot-impact');
                setTimeout(() => this.el.slotYou.classList.remove('slot-impact'), 200);

                this.render();
                setTimeout(() => this.state.table.ai ? this.resolveTrick() : this.aiPlay(), 450);
            }, 150);
        },
        aiDecisionEngine() {
            if (this.state.gameMode !== 'ironHand') {
                for (const hero of this.state.aiTeam) {
                    if (!hero || hero.type === 'passive' || hero.type === 'hybrid') continue;
                    const cargaReq = parseInt(hero.ability.base.match(/Cost (\d+) Charge/)?.[1] || 99);
                    if (this.state.aiCarga < cargaReq) continue;
                    const aiHandSorted = [...this.state.ai].sort((a, b) => this.cardStrength(b, 'ai') - this.cardStrength(a, 'ai'));

                    switch (hero.id) {
                        case 'silo':
                            if (this.state.trick === 1 && this.cardStrength(aiHandSorted[0], 'ai') < "4567QJKA23".indexOf('K')) {
                                this.aiActivateAbility(hero);
                                return { action: 'ability_used' };
                            }
                            break;
                        case 'dory':
                            const hasManilha = this.state.ai.some(c => this.isManilha(c));
                            if (this.state.trick === 1 && !hasManilha) {
                                this.aiActivateAbility(hero);
                                return { action: 'ability_used' };
                            }
                            break;
                    }
                }
            }
            
            let chosen;
            const sortedHand = [...this.state.ai].sort((a, b) => this.cardStrength(a, 'ai') - this.cardStrength(b, 'ai'));
            const playerCard = this.state.table.you;

            if (this.state.forcePlay) {
                 chosen = this.state.forcePlay === 'highest' ? sortedHand[sortedHand.length - 1] : sortedHand[0];
                 this.state.forcePlay = null; 
                 this.state.gaiaAbilityJustUsed = true;
            } else if (playerCard) {
                const winningCards = sortedHand.filter(c => this.cardStrength(c, 'ai') > this.cardStrength(playerCard, 'you'));
                chosen = winningCards.length > 0 ? winningCards[0] : sortedHand[0];
            } else {
                chosen = sortedHand[Math.floor(sortedHand.length / 2)];
            }
            return { action: 'play_card', card: chosen };
        },
        aiActivateAbility(hero) {
            const cargaReq = parseInt(hero.ability.active_desc?.match(/Cost (\d+) Charge/)?.[1] || hero.ability.base.match(/Cost (\d+) Charge/)?.[1] || 99);
            this.state.aiCarga -= cargaReq;
            UIManager.showNotification(`Corp ativa ${hero.name}: ${hero.ability.name}!`, 'danger');
            SoundManager.playAbilityActivate();
            switch (hero.id) {
                case 'silo':
                    if(this.state.deck.length > 0) {
                        const newCard = this.state.deck.pop();
                        this.state.ai.push(newCard);
                        const cardToDiscard = this.state.ai.sort((a, b) => this.cardStrength(a, 'ai') - this.cardStrength(b, 'ai'))[0];
                        this.state.ai.splice(this.state.ai.indexOf(cardToDiscard), 1);
                    }
                    break;
                case 'dory':
                    if (this.state.deck.length > 0) {
                        const newVira = this.state.deck.pop();
                        this.state.vira = newVira;
                        const rankOrder = ["4", "5", "6", "7", "Q", "J", "K", "A", "2", "3"];
                        this.state.manilhaRank = rankOrder[(rankOrder.indexOf(this.state.vira.r) + 1) % rankOrder.length];
                    }
                    break;
            }
            this.render();
        },
        aiPlay() {
            if (this.state.leader !== 'ai' || this.state.asking) return;
            
            const decision = this.aiDecisionEngine();
            if (decision.action === 'ability_used') {
                setTimeout(() => this.aiPlay(), 1000); 
                return;
            }
            if (decision.action === 'play_card' && decision.card) {
                const chosen = decision.card;
                if (this.isManilha(chosen)) { SoundManager.playManilhaSlam(); } else { SoundManager.playCardSlam(); }
                this.state.table.ai = chosen;
                this.state.lastPlayedCard = chosen;
                this.state.ai.splice(this.state.ai.indexOf(chosen), 1);
                this.state.leader = 'you';
                this.el.slotAI.classList.add('slot-impact');
                setTimeout(() => this.el.slotAI.classList.remove('slot-impact'), 200);
                this.render();
                if (this.state.table.you) {
                    setTimeout(() => this.resolveTrick(), 450);
                } else {
                    this.startOfTrickEffects();
                }
            }
        },
        continueAfterBattle(winner) {
            const yc = this.state.table.you;
            const ac = this.state.table.ai;

            // ✨ CÓDIGO ATUALIZADO ✨: Lógica de carga com bônus
            if(winner === 'you') this.state.youCarga++; else this.state.aiCarga++;
            UIManager.showNotification(`+1 Charge for ${winner === 'you' ? 'you' : 'the Corp'}`, 'charge');
            if (this.el.screen.classList.contains('scenario-broken')) {
                if(winner === 'you') this.state.youCarga++; else this.state.aiCarga++;
                UIManager.showNotification(`System Overload: +1 Bonus Charge!`, 'warning');
            }

            // *** MODIFICADO: Lógica de Jolt só se aplica se não for Mão de Ferro ***
            if (this.state.gameMode !== 'ironHand') {
                const playerJolt = this.state.playerTeam.find(h => h && h.id === 'jolt');
                if (playerJolt && winner === 'you' && !this.isManilha(yc) && !this.isManilha(ac) && this.cardStrength(yc, 'you') > this.cardStrength(ac, 'ai')) {
                    this.state.youCarga++;
                    UIManager.showNotification("Battle Frenzy: +1 Bonus Charge!", 'charge');
                }
                const aiJolt = this.state.aiTeam.find(h => h && h.id === 'jolt');
                if (aiJolt && winner === 'ai' && !this.isManilha(ac) && !this.isManilha(yc) && this.cardStrength(ac, 'ai') > this.cardStrength(yc, 'you')) {
                    this.state.aiCarga++;
                     UIManager.showNotification("Corp's Battle Frenzy: +1 Bonus Charge!", 'danger');
                }

                if (this.state.gaiaAbilityJustUsed) {
                    this.state.aiCarga += 2;
                    UIManager.showNotification("Corp recovers 2 Charge from Vine's Embrace.", 'charge');
                    this.state.gaiaAbilityJustUsed = false;
                }
            }
            const winnerHUD = winner === 'you' ? this.el.handYou.closest('.player-area').querySelector('.player-hud') : this.el.handAI.closest('.player-area').querySelector('.player-hud');
            const winnerMarkers = winner === 'you' ? this.el.trickMarkersYou : this.el.trickMarkersAI;
            const trickIndex = winner === 'you' ? this.state.youTricks : this.state.aiTricks;
            if (winnerMarkers && winnerMarkers.children[trickIndex]) { winnerMarkers.children[trickIndex].classList.add('won'); }
            if(winnerHUD){ winnerHUD.classList.add('point-awarded-glow'); setTimeout(() => winnerHUD.classList.remove('point-awarded-glow'), 800); }
            if (this.state.gameMode !== 'ironHand' && this.state.playerTeam.length > 0) {
                const activeHero = this.state.playerTeam[0];
                const heroCard = document.getElementById(`sidebar-hero-${activeHero.id}`);
                if (heroCard) {
                    const glowClass = winner === 'you' ? 'trick-win-glow' : 'trick-lose-glow';
                    heroCard.classList.add(glowClass);
                    setTimeout(() => heroCard.classList.remove(glowClass), 800);
                }
            }
            if (winner === 'you') {
                this.state.youTricks++;
                SoundManager.playTrickWin();
                // ✨ MUDANÇA: Rastreia a missão de vencer rodadas
                PlayerData.trackMission('win_tricks');
            } else {
                this.state.aiTricks++;
                SoundManager.playTrickLose();
            }
            this.state.leader = winner;
            this.state.trick++;
            this.state.table = { you: null, ai: null };
            if (this.state.youTricks >= 2 || this.state.aiTricks >= 2) { this.endHand(winner); } 
            else { setTimeout(() => { this.render(); this.startOfTrickEffects(); if (this.state.leader === 'ai') this.aiPlay(); }, 700); }
        },
        resolveTrick() {
            const yc = this.state.table.you;
            const ac = this.state.table.ai;
            if (!yc || !ac) return;

            this.el.slotYou.innerHTML = '';
            this.el.slotAI.innerHTML = '';
            
            const winner = this.cardStrength(yc, 'you') > this.cardStrength(ac, 'ai') ? 'you' : 'ai';
            const arena = document.getElementById('battle-arena');
            arena.innerHTML = '';

            const playerCardEl = this.cardView(yc, false);
            const aiCardEl = this.cardView(ac, false);
            arena.append(playerCardEl, aiCardEl);
            SoundManager.playCardSlam();
            playerCardEl.classList.add('battle-enter-player');
            aiCardEl.classList.add('battle-enter-ai');
            setTimeout(() => {
                playerCardEl.classList.remove('battle-enter-player');
                aiCardEl.classList.remove('battle-enter-ai');
                const winnerEl = (winner === 'you') ? playerCardEl : aiCardEl;
                const loserEl = (winner === 'you') ? aiCardEl : playerCardEl;
                const winnerTransform = window.getComputedStyle(winnerEl).transform;
                const loserTransform = window.getComputedStyle(loserEl).transform;
                winnerEl.style.setProperty('--transform-start', winnerTransform);
                loserEl.style.setProperty('--transform-start', loserTransform);
                SoundManager.playSystemBreach(); 
                winnerEl.classList.add('battle-winner');
                loserEl.classList.add('battle-loser');
            }, 500);
            setTimeout(() => {
                arena.innerHTML = '';
                this.continueAfterBattle(winner);
            }, 1500); 
        },
        endHand(winner) {
            const isIronHand = this.state.gameMode === 'ironHand';
            
            if (!isIronHand) {
                const pts = this.getStake();
                if (winner === 'you') { this.state.ptsYou += pts; PlayerData.trackMission('win_hands'); } 
                else { this.state.ptsAI += pts; }
            }

            if (isIronHand) {
                if (winner === 'you') { this.state.ironHandYouWins++; } 
                else { this.state.ironHandAIWins++; }

                if (this.state.ironHandYouWins >= 2 || this.state.ironHandAIWins >= 2) {
                    const won = this.state.ironHandYouWins >= 2;
                    this.el.endGameTitle.textContent = won ? '🎉 VICTORY IN IRON HAND! 🎉' : 'Defeat in Iron Hand';
                    let rewardText = '';
                    if (won) {
                        const r = CONSTANTS.IRON_HAND_REWARDS;
                        PlayerData.addCoins(r.coins);
                        PlayerData.addXP(r.xp);
                        PlayerData.addGems(r.gems);
                        SoundManager.playLevelUp();
                        rewardText = ` You won ${r.coins} Coins, ${r.xp} XP and ${r.gems} Chip!`;
                    } else {
                        SoundManager.playTrickLose();
                        rewardText = " Better luck next time. The resistance needs you.";
                    }
                    this.el.endGameText.textContent = `Final Score: You ${this.state.ironHandYouWins} x ${this.state.ironHandAIWins} Corp.${rewardText}`;
                    this.el.btnNewMatch.textContent = "Back to Lobby";
                    this.el.btnNewMatch.onclick = () => { SoundManager.playUIClick(); this.el.modalEndGame.classList.remove('show'); Navigation.show('lobby'); };
                    this.el.modalEndGame.classList.add('show');
                } else {
                    this.el.endHandTitle.textContent = winner === 'you' ? `You won the hand!` : `The Corp won the hand!`;
                    this.el.endHandText.textContent = `Score: You ${this.state.ironHandYouWins} x ${this.state.ironHandAIWins} Corp. Best of 3.`;
                    this.el.modalEndHand.classList.add('show');
                }
            } else {
                if (this.state.ptsYou >= 12 || this.state.ptsAI >= 12) {
                    const won = this.state.ptsYou >= 12;
                    PlayerData.trackMission('complete_matches');
                    this.el.endGameTitle.textContent = won ? '🎉 You Won the Match! 🎉' : 'Defeat';
                    this.el.endGameText.textContent = `Final Score: You ${this.state.ptsYou} x ${this.state.ptsAI} Corp.`;
                    if (won) {
                        PlayerData.addXP(CONSTANTS.MATCH_WIN_XP);
                        PlayerData.addCoins(CONSTANTS.MATCH_WIN_COINS);
                        SoundManager.playLevelUp();
                    } else {
                        PlayerData.addXP(CONSTANTS.MATCH_COMPLETION_XP);
                        PlayerData.addCoins(CONSTANTS.MATCH_COMPLETION_COINS);
                        SoundManager.playTrickLose();
                    }
                    this.el.btnNewMatch.textContent = "Play Again";
                    this.el.btnNewMatch.onclick = () => { SoundManager.playUIClick(); this.el.modalEndGame.classList.remove('show'); this.newMatch(); };
                    this.el.modalEndGame.classList.add('show');
                } else {
                    this.el.endHandTitle.textContent = winner === 'you' ? `You won the hand!` : `The Corp won the hand!`;
                    this.el.endHandText.textContent = `Score: You ${this.state.ptsYou} x ${this.state.ptsAI} Corp.`;
                    this.el.modalEndHand.classList.add('show');
                }
            }
        },
        cardStrength(c, playerType) { 
            if (!c) return -1; 
            const suitPower = {"♣":4,"♥":3,"♠":2,"♦":1}; 
            if(this.isManilha(c)) return 100 + suitPower[c.s];
            let baseStrength = "4567QJKA23".indexOf(c.r);
            // *** MODIFICADO: Lógica de Gaia só se aplica se não for Mão de Ferro ***
            if (this.state.gameMode !== 'ironHand') {
                const gaia = playerType === 'you' 
                    ? this.state.playerTeam.find(h => h && h.id === 'gaia') 
                    : this.state.aiTeam.find(h => h && h.id === 'gaia');
                if (gaia) {
                    const hand = playerType === 'you' ? this.state.you : this.state.ai;
                    if (hand.includes(c) && ['♦', '♣'].includes(this.state.vira.s)) {
                        const yourHandSorted = [...hand].sort((a,b) => "4567QJKA23".indexOf(a.r) - "4567QJKA23".indexOf(b.r));
                        if (c.r === yourHandSorted[0].r && c.s === yourHandSorted[0].s) { baseStrength += 2; }
                    }
                }
            }
            return baseStrength;
        },
        isManilha(c) { return c && c.r === this.state.manilhaRank; },
        getStake() { return this.stakePoints[this.state.stakeIdx]; },

        // ✨ CÓDIGO ATUALIZADO ✨
        askTruco(who) {
            if (this.state.stakeIdx >= this.stakeLadder.length - 1) return;
            if (this.state.stakeIdx === 0) { this.state.stakeIdx = 1; }
            else { this.state.stakeIdx++; }
            this.state.asking = who === 'you' ? 'ai' : 'you';
            this.state.lastRaiser = who;

            SoundManager.playSystemBreach();
            
            this.el.trucoTable.style.animation = 'table-slam-effect 0.5s ease-out';
            
            const callText = this.stakeLadder[this.state.stakeIdx - 1];
            
            let isCloaked = false;
            if (this.state.gameMode !== 'ironHand') {
                const playerPhantom = this.state.playerTeam.find(h => h && h.id === 'phantom');
                const aiPhantom = this.state.aiTeam.find(h => h && h.id === 'phantom');
                isCloaked = (playerPhantom && who === 'ai') || (aiPhantom && who === 'you');
            }
            this.el.trucoOverlay.textContent = isCloaked ? '???' : callText + "!";
            this.el.trucoOverlay.classList.add('show');
            this.el.trucoOverlay.style.animation = 'truco-text-anim 0.6s ease-out forwards';
            
            setTimeout(() => {
                this.el.trucoTable.style.animation = '';
                this.el.trucoOverlay.classList.remove('show');
                this.el.trucoOverlay.style.animation = '';
            }, 600);
            
            if (who === 'you') {
                if (this.state.gameMode !== 'ironHand') this.getBanter('truco');
                PlayerData.trackMission('ask_truco');
                setTimeout(() => this.aiRespondToTruco(), 1200);
            } else {
                UIManager.showNotification(`The Corp called ${callText}!`, 'warning');
                this.startDecisionTimer(CONSTANTS.DECISION_TIMER_SECONDS);
            }
            this.render();
        },
        aiRespondToTruco() {
            const strongestCard = [...this.state.ai].sort((a, b) => this.cardStrength(b, 'ai') - this.cardStrength(a, 'ai'))[0];
            const strength = this.cardStrength(strongestCard, 'ai');
            const canRaise = this.state.stakeIdx < this.stakeLadder.length - 1;
            if (strength >= 100 && canRaise && Math.random() < 0.75) { this.respondToTruco('ai', 'raise'); }
            else if (strength >= "4567QJKA23".indexOf('K')) { this.respondToTruco('ai', 'accept'); }
            else { this.respondToTruco('ai', 'run'); }
        },
        respondToTruco(who, response) {
            this.el.trucoTable.classList.remove('glitching');
            
            const opponent = (who === 'you') ? 'ai' : 'you';
            if (response === 'accept') { 
                this.el.screen.classList.add('scenario-broken');
                UIManager.showNotification("System Overload! Trick winners gain +1 bonus Charge!", 'warning');
                this.state.asking = null; this.state.leader = opponent; 
                SoundManager.playUIClick(); this.render(); 
                if (this.state.leader === 'ai') setTimeout(() => this.aiPlay(), 450); 
                else this.startOfTrickEffects();
            }
            else if (response === 'run') { 
                const points = this.state.stakeIdx > 1 ? this.stakePoints[this.state.stakeIdx - 1] : 1; 
                UIManager.showNotification(`${who === 'you' ? 'You' : 'The Corp'} ran! ${opponent === 'you' ? 'You' : 'The Corp'} won ${points} point(s).`, 'info'); 
                if (opponent === 'you') { this.state.ptsYou += points; this.state.youCarga += 2; } else { this.state.ptsAI += points; this.state.aiCarga += 2; }
                this.state.asking = null; 
                if (this.state.ptsYou >= 12 || this.state.ptsAI >= 12) { this.endHand(opponent); } 
                else { this.newHand(); } 
            }
            else if (response === 'raise') { this.askTruco(who); }
        },
        startDecisionTimer(seconds) {
            this.clearDecisionTimer();
            const timerContainer = document.getElementById('decision-timer-container');
            const timerBar = document.getElementById('decision-timer-bar');
            timerContainer.classList.remove('hidden');
            timerBar.style.width = '100%';
            let timeLeft = seconds;
            this.decisionInterval = setInterval(() => {
                timeLeft -= 0.1;
                timerBar.style.width = `${(timeLeft / seconds) * 100}%`;
                if (timeLeft <= 0) {
                    this.clearDecisionTimer();
                    this.respondToTruco('you', 'run');
                }
            }, 100);
        },
        clearDecisionTimer() {
            if (this.decisionInterval) {
                clearInterval(this.decisionInterval);
                this.decisionInterval = null;
                document.getElementById('decision-timer-container').classList.add('hidden');
            }
        },
        applyPassiveAbilities() { },
        startOfTrickEffects() {
            if (this.state.asking || this.state.gameMode === 'ironHand') return;
            
            const echo = this.state.playerTeam.find(h => h && h.id === 'echo');
            if (echo && this.state.leader === 'you') {
                const hasManilha = this.state.ai.some(c => this.isManilha(c));
                const msg = hasManilha ? "Continuous Scan: Strongest Card Detected in Corp's hand!" : "Continuous Scan: No strongest card detected.";
                UIManager.showNotification(msg, 'info');
                SoundManager.playAbilityActivate();
            }
        },
        activateAbility(heroId) {
            const hero = this.state.playerTeam.find(h => h.id === heroId);
            if (!hero) return;
            const cargaReq = parseInt(hero.ability.active_desc?.match(/Cost (\d+) Charge/)?.[1] || hero.ability.base.match(/Cost (\d+) Charge/)?.[1] || 99);
            if (this.state.youCarga < cargaReq) return;
            this.state.youCarga -= cargaReq;
            const heroCard = document.getElementById(`sidebar-hero-${heroId}`);
            const screen = document.getElementById('truco-screen');
            const table = this.el.trucoTable;
            if (heroCard) heroCard.classList.add('hero-ability-activated');
            if (screen) screen.classList.add('screen-ability-flash');
            if (table) table.classList.add('table-ability-ripple');
            setTimeout(() => {
                if (heroCard) heroCard.classList.remove('hero-ability-activated');
                if (screen) screen.classList.remove('screen-ability-flash');
                if (table) table.classList.remove('table-ability-ripple');
            }, 600);
            SoundManager.playAbilityActivate();
            switch (heroId) {
                case 'silo':
                    this.state.isDiscarding = true;
                    const newCard = this.state.deck.pop();
                    this.state.you.push(newCard);
                    UIManager.showNotification("Sleight of Hand: Draw a card, now discard one.", "info");
                    this.render();
                    break;
                case 'dory':
                    this.state.isChoosingVira = true;
                    this.el.doryCardChoices.innerHTML = '';
                    const choices = this.state.deck.splice(0, 3);
                    choices.forEach(card => {
                        const cardEl = this.cardView(card, false);
                        cardEl.onclick = () => {
                            choices.forEach(otherCard => {
                                if (otherCard !== card) this.state.deck.push(otherCard);
                            });
                            for (let i = this.state.deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[this.state.deck[i], this.state.deck[j]] = [this.state.deck[j], this.state.deck[i]]; }
                            this.state.vira = card;
                            const rankOrder = ["4", "5", "6", "7", "Q", "J", "K", "A", "2", "3"];
                            this.state.manilhaRank = rankOrder[(rankOrder.indexOf(this.state.vira.r) + 1) % rankOrder.length];
                            this.state.isChoosingVira = false;
                            UIManager.hideModal('dory-choice-modal');
                            UIManager.showNotification("Fate Distorted! New Trump Card selected.", "info");
                            this.render();
                        };
                        this.el.doryCardChoices.appendChild(cardEl);
                    });
                    UIManager.showModal('dory-choice-modal');
                    this.render();
                    break;
                case 'phantom':
                    this.clearDecisionTimer();
                    UIManager.showNotification("Spectral Swap canceled the bet and caused chaos!", "info");
                    this.state.stakeIdx--;
                    this.state.asking = null;
                    if (this.state.you.length > 0 && this.state.ai.length > 0) {
                        const myCardIndex = Math.floor(Math.random() * this.state.you.length);
                        const aiCardIndex = Math.floor(Math.random() * this.state.ai.length);
                        const tempCard = this.state.you[myCardIndex];
                        this.state.you[myCardIndex] = this.state.ai[aiCardIndex];
                        this.state.ai[aiCardIndex] = tempCard;
                    }
                    this.state.leader = 'you';
                    this.render();
                    this.startOfTrickEffects();
                    break;
                case 'gaia':
                    SoundManager.playNaturesGrasp();
                    this.state.forcePlay = 'highest';
                    UIManager.showNotification("Vine's Embrace will force the Corp to play its strongest card!", "info");
                    this.render();
                    break;
            }
        },
        executeDiscard(cardToDiscard) { 
            const index = this.state.you.indexOf(cardToDiscard);
            if (index > -1) { 
                this.state.you.splice(index, 1);
                this.state.deck.unshift(cardToDiscard);
                this.state.isDiscarding = false; 
                UIManager.showNotification("Card discarded.", "info"); 
                this.render(); 
            } 
        },
        async getBanter(context) {
            if (!this.state.playerTeam || this.state.playerTeam.length === 0) return;
            const speakingRebel = this.state.playerTeam[0];
            if(!speakingRebel) return;
            const heroCard = document.getElementById(`sidebar-hero-${speakingRebel.id}`);
            if (heroCard) heroCard.classList.add('is-speaking');
            const banter = await GeminiHelper.generateText('truco', { context, rebelName: speakingRebel.name });
            this.el.banterBox.innerHTML = `<span style="color: var(--accent-blue); font-weight: bold;">${speakingRebel.name}:</span> "${banter}"`;
            this.el.banterBox.style.opacity = 1;
            setTimeout(() => {
                this.el.banterBox.style.opacity = 0;
                if (heroCard) heroCard.classList.remove('is-speaking');
            }, 4000);
        }
    };
    
    // =================================================================================
    // GEMINI API HELPER MODULE
    // =================================================================================
    const GeminiHelper = {
        async generateText(type, data) {
            // ATENÇÃO: Nunca exponha sua chave de API diretamente no código do frontend.
            // Para um projeto em produção, a chamada para a API Gemini deve ser feita por um backend seguro.
            // A chave está vazia aqui para permitir que o sistema de fallback funcione.
            const apiKey = ""; 
            if (!apiKey) {
                const fallbacks = {
                    start: ["Let's finish them.", "The network is ours.", "Show no mercy."],
                    truco: ["Raise the stakes!", "They don't stand a chance.", "It's now or never."],
                    manilha: ["Key Protocol activated!", "Impossible to stop.", "This ends here."]
                };
                const choices = fallbacks[data.context] || ["..."];
                return choices[Math.floor(Math.random() * choices.length)];
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            let prompt = "";
            switch(type) {
                case 'truco': prompt = `You are ${data.rebelName}, an arrogant cyberpunk rebel in the clandestine game Revs. Your opponent just made a move: ${data.context}. Say a short, witty, and rebellious taunt (max 10 words). Respond in English.`; break;
            }
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { console.error("API Response Error:", await response.text()); return "The data is corrupted..."; }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) { return result.candidates[0].content.parts[0].text; }
                return "The connection failed...";
            } catch (error) { console.error("Fetch Error:", error); return "There was interference in the signal..."; }
        }
    };

    // =================================================================================
    // GLOBAL GAME INITIALIZATION
    // =================================================================================
    window.onload = () => {
        PlayerData.init();
        GameManager.init();
        Navigation.init();
        TrucoGame.init();
        MissionsManager.init();
        UIManager.init();

        // === ADIÇÃO: Lógica para o efeito de holograma no Lobby ===
        const mainGameCard = document.getElementById('nav-truco');
        const lobby = document.getElementById('main-lobby');

        lobby.addEventListener('mousemove', (e) => {
            // Aplica o efeito apenas se o card principal estiver visível e o mouse sobre ele
            if (mainGameCard.matches(':hover') && !lobby.classList.contains('hidden')) {
                const rect = mainGameCard.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                // Ajuste os divisores para mais/menos sensibilidade
                const rotateX = (y - centerY) / 20; 
                const rotateY = -(x - centerX) / 20;

                mainGameCard.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
                mainGameCard.style.transition = 'transform 0.1s linear';
            }
        });

        // Reseta o efeito quando o mouse sai do card
        mainGameCard.addEventListener('mouseleave', () => {
            mainGameCard.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
            mainGameCard.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        });

    };
    </script>
</body>
</html>
